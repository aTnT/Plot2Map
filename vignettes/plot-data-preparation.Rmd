---
title: "Plot data preparation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{plot-data-preparation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = FALSE}
#library(Plot2Map)
devtools::load_all()
```


## Introduction

In this page we showcase the different user data formats of plot estimates of AGB, here refereed as plot data, possible to be used in the Plot2Map workflow.

## Plot data formats

### Point data formatted dataframe

In this case there is already an AGB estimate from the user. This format is exemplified with the sample plots dataframe available with the package accessible with:

```{r plots}
head(plots) 

```

This format correspond to a dataframe containing sample plots with an unique plot ID, longitude and latitude point data, an estimated Above Ground Biomass in t/ha, average year of inventory, and plot size in ha.



### Point data unformatted dataframe



In this case there is also a dataframe in a similar format to the previous case, but with unformatted data over which the user will be asked about the specific column index of required plot variables such as unique plot ID, longitude, latitude, AGB of the plot, plot size, inventory year. This can be exemplified below:

```{r unformatted plots1, eval=FALSE}

unformatted_plots <- utils::read.csv(sample_file("SampleUnformattedPlots.csv"))
head(unformatted_plots)
#      Provincia                          Estrato.Florestal id_parcela Ycoordinate Xcoordinate Vt..m.3.ha.
# 1 Cabo Delgado Floresta (semi-) decidua, incluindo Miombo  CD0772003   -10.60656    40.53664       39.90
# 2 Cabo Delgado Floresta (semi-) decidua, incluindo Miombo  CD0772002   -10.60657    40.53572       24.65
# 3 Cabo Delgado Floresta (semi-) decidua, incluindo Miombo  CD0770543   -10.60666    40.52744        4.09
# 4 Cabo Delgado Floresta (semi-) decidua, incluindo Miombo  CD0770542   -10.60667    40.52652       20.06
# 5 Cabo Delgado Floresta (semi-) decidua, incluindo Miombo  CD0772004   -10.60747    40.53664        0.00
# 6 Cabo Delgado Floresta (semi-) decidua, incluindo Miombo  CD0772001   -10.60747    40.53573       64.15
#   Vc..m.3.ha. AGB..ton.ha. BGB..ton.ha. year size
# 1        2.53        32.61        21.73 2016  0.1
# 2        0.77        21.44        13.32 2016  0.1
# 3        0.00         4.41         2.96 2016  0.1
# 4        2.38        17.77        10.56 2016  0.1
# 5        0.00         0.00         0.00 2016  0.1
# 6        0.97        77.74        27.38 2016  0.1

```

The following step will request the user to select the requested columns:

```{r unformatted plots2, eval=FALSE}

formatted_plots <- RawPlots(unformatted_plots)
# Which column is your unique Plot ID? 
# 
#  1: Manual entry        2: Provincia           3: Estrato.Florestal
#  4: id_parcela          5: Ycoordinate         6: Xcoordinate      
#  7: Vt..m.3.ha.         8: Vc..m.3.ha.         9: AGB..ton.ha.     
# 10: BGB..ton.ha.       11: year               12: size             
# 
# 
# Selection: 4
# Which column is your plot AGB? 
# 
#  1: Manual entry        2: Provincia           3: Estrato.Florestal
#  4: id_parcela          5: Ycoordinate         6: Xcoordinate      
#  7: Vt..m.3.ha.         8: Vc..m.3.ha.         9: AGB..ton.ha.     
# 10: BGB..ton.ha.       11: year               12: size             
# 
# 
# Selection: 9
# Select longitude column 
# 
#  1: Manual entry        2: Provincia           3: Estrato.Florestal
#  4: id_parcela          5: Ycoordinate         6: Xcoordinate      
#  7: Vt..m.3.ha.         8: Vc..m.3.ha.         9: AGB..ton.ha.     
# 10: BGB..ton.ha.       11: year               12: size             
# 
# 
# Selection: 6
# Which column is your latitude? 
# 
#  1: Manual entry        2: Provincia           3: Estrato.Florestal
#  4: id_parcela          5: Ycoordinate         6: Xcoordinate      
#  7: Vt..m.3.ha.         8: Vc..m.3.ha.         9: AGB..ton.ha.     
# 10: BGB..ton.ha.       11: year               12: size             
# 
# 
# Selection: 5
# Select plot size column 
# 
#  1: Manual entry        2: Provincia           3: Estrato.Florestal
#  4: id_parcela          5: Ycoordinate         6: Xcoordinate      
#  7: Vt..m.3.ha.         8: Vc..m.3.ha.         9: AGB..ton.ha.     
# 10: BGB..ton.ha.       11: year               12: size             
# 
# 
# Selection: 12
# Select year column 
# 
#  1: Manual entry        2: Provincia           3: Estrato.Florestal
#  4: id_parcela          5: Ycoordinate         6: Xcoordinate      
#  7: Vt..m.3.ha.         8: Vc..m.3.ha.         9: AGB..ton.ha.     
# 10: BGB..ton.ha.       11: year               12: size             
# 
# 
# Selection: 11


```

Note how after user input we get a similar data format to the previous section:

```{r unformatted plots3, eval=FALSE}

tail(formatted_plots)
#      PLOT_ID  POINT_X   POINT_Y AGB_T_HA SIZE_HA FEZ GEZ AVG_YEAR
# 3267      21 32.35752 -26.54318    54.13     0.1  NA  NA     2016
# 3268      24 32.35853 -26.54318    13.90     0.1  NA  NA     2016
# 3269      12 32.75884 -26.65187    92.66     0.1  NA  NA     2016
# 3270      13 32.75984 -26.65187   112.87     0.1  NA  NA     2016
# 3271      11 32.75884 -26.65277    56.08     0.1  NA  NA     2016
# 3272      14 32.75984 -26.65277    65.59     0.1  NA  NA     2016

```


This format correspond to a dataframe containing sample plots with an ID, longitude and latitude point data, an estimated Above Ground Biomass in t/ha, average year of plot survey, and plot size in ha.



### Plot corner coordinates

This is the plot data format found in [Labriere et al. 2018](https://doi.org/10.1109/JSTARS.2018.2851606) sample data. It contains the corner coordinates of a bounding box defining each plot:


```{r polygon_corner_coords, eval=FALSE}

plots_corners <- utils::read.csv(sample_file("PolyTropiSAR.csv")) # Labriere et al. 2018 plots sample data
head(plots_corners)
#     id  POINT_X  POINT_Y  X
# 1 NOU01 312514.3 449724.3 NA
# 2 NOU01 312517.6 449824.2 NA
# 3 NOU02 313704.3 451320.5 NA
# 4 NOU02 313752.2 451408.3 NA
# 5 NOU02 313800.0 451496.1 NA
# 6 NOU02 313847.9 451583.9 NA

plots_AGB <-  utils::read.csv(sample_file("PolyTropiAGB.csv")) # plot-level AGB
head(plots_AGB)
#   PLOT_ID AVG_YEAR AGB_T_HA
# 1   NOU01     2010   431.90
# 2   NOU02     2010   368.41
# 3   NOU03     2010   525.65
# 4   NOU04     2010   429.87
# 5   NOU05     2010   234.60
# 6   NOU06     2010   288.10

SRS <- 32622 # plot data spatial reference system
plots_corners_AGB <- Polygonize(plots_corners, SRS)
plots_corners_AGB$AGB_T_HA <- plots_AGB$AGB_T_HA
plots_corners_AGB$AVG_YEAR <- plots_AGB$AVG_YEAR

head(plots_corners_AGB)
#       ID PLOT_ID        SIZE_HA   POINT_X       POINT_Y AGB_T_HA AVG_YEAR
# NOU01  1   NOU01 0.6971249 [ha] -55.48901  3.888050e-04   431.90     2010
# NOU02  1   NOU02 1.8970650 [ha] -55.48835  1.302744e-04   368.41     2010
# NOU03  1   NOU03 2.6599369 [ha] -55.48853  1.519248e-04   525.65     2010
# NOU04  1   NOU04 2.2067426 [ha] -55.48865  4.301939e-05   429.87     2010
# NOU05  1   NOU05 0.1436755 [ha] -55.48813  6.329935e-04   234.60     2010
# NOU06  1   NOU06 0.2499998 [ha] -55.48886 -4.925199e-04   288.10     2010

```





### Plot data contains tree-level measurements

This format of plot data contains tree-level alometric measurements that will be used to 
estimate AGB and associated standard deviation, using [BIOMASS](https://umr-amap.github.io/BIOMASS/) R package.


```{r plot_trees, eval=FALSE}

# Formatted data example
plotsTree <- utils::read.csv(sample_file("SampleTree.csv"))
head(plotsTree)
#     id      genus    species  diameter  size                 fez      gez year
# 1 BSP1 Terminalia  bellirica  3.501409 10000 tropical rainforest tropical 1996
# 2 BSP1   Ziziphus   oenoplia  3.819719 10000 tropical rainforest tropical 1996
# 3 BSP1    Aporosa lindleyana 16.870424 10000 tropical rainforest tropical 1996
# 4 BSP1      Ixora  brachiata  4.138029 10000 tropical rainforest tropical 1996
# 5 BSP1   Wrightia    arborea  5.411268 10000 tropical rainforest tropical 1996
# 6 BSP1      Ixora  brachiata  3.183099 10000 tropical rainforest tropical 1996

xyTree <- utils::read.csv(sample_file("SampleTreeXY.csv"))
head(xyTree)
#     id        y        x
# 1 BSP1 14.36806 74.91944
# 2 BSP1 14.36806 74.91944
# 3 BSP1 14.36806 74.91944
# 4 BSP1 14.36806 74.91944
# 5 BSP1 14.36806 74.91944
# 6 BSP1 14.36806 74.91944

# Unformatted data example
TreeRaw <- utils::read.csv(sample_file("KarnatakaForest.csv"))
head(TreeRaw)
#   plotId     treeId     family       genus        species     d_cm      lat     long size_m2 year
# 1   BSP1   BSP1_248 Clusiaceae    Garcinia         indica 3.183099 14.36806 74.91944   10000 1998
# 2   BSP1   BSP1_269  Rubiaceae       Ixora      brachiata 3.183099 14.36806 74.91944   10000 1998
# 3   BSP1 BSP1_303_B  Rubiaceae       Meyna      laxiflora 3.183099 14.36806 74.91944   10000 1998
# 4   BSP1    BSP1_29  Lauraceae Alseodaphne semecarpifolia 3.501409 14.36806 74.91944   10000 1998
# 5   BSP1    BSP1_30  Lauraceae Alseodaphne semecarpifolia 3.501409 14.36806 74.91944   10000 1998
# 6   BSP1    BSP1_31  Lauraceae Alseodaphne semecarpifolia 3.501409 14.36806 74.91944   10000 1998

rawTree <- RawPlotsTree(TreeRaw) # User is be asked to select the requested columns

plotTree <- rawTree[[1]]
head(plotTree)
#   id       genus        species diameter  size fez gez year
# 1 11    Garcinia         indica 3.183099 10000  NA  NA 1998
# 2 11       Ixora      brachiata 3.183099 10000  NA  NA 1998
# 3 11       Meyna      laxiflora 3.183099 10000  NA  NA 1998
# 4 11 Alseodaphne semecarpifolia 3.501409 10000  NA  NA 1998
# 5 11 Alseodaphne semecarpifolia 3.501409 10000  NA  NA 1998
# 6 11 Alseodaphne semecarpifolia 3.501409 10000  NA  NA 1998

xyTree <- rawTree[[2]]
head(xyTree)
#   id        x        y
# 1 11 74.91944 14.36806
# 2 11 74.91944 14.36806
# 3 11 74.91944 14.36806
# 4 11 74.91944 14.36806
# 5 11 74.91944 14.36806
# 6 11 74.91944 14.36806

plots_trees_agb_sd <- MeasurementErr(plotTree, xyTree, "India")

```










## (5) PLOT DATA WITH TREE-LEVEL MEASUREMENT AND NESTED PLOTS (SUB-PLOTS)

cent <- readOGR(dsn = dataDir, layer = "SampleCentroid") #Sub-plot centroid
tree <- read.csv(paste0(dataDir,'/SampleTreeNested.csv')) #Tree data per sub-plot
TreeData <- Nested(cent, tree)
plotTree <- TreeData[[1]]
xyTree <- TreeData[[2]]
plots <- MeasurementErr(plotTree, xyTree, 'Europe')


## (6) REFERENCE DATA IS A LIDAR-BASED MAP

slb.agb.dir <- './SustainableLandscapeBrazil_v04/SLB_AGBmaps'
slb.cv.dir <- './SustainableLandscapeBrazil_v04/SLB_CVmaps'
slb.cv <- RefLidar(slb.cv.dir, 2018)
plots <- RefLidar(slb.agb.dir, 2018)
plots$sdTree <- slb.cv$CV * plots$AGB_T_HA


## (7) PLOT DATA IS A SHAPEFILE
plotsFile <- 'samp_shp.shp'
plots_sf <- st_read(plotsFile)
plots_sf <- st_transform(plots_sf, crs = 4326)
plots_sf$longitude <- st_coordinates(st_centroid(plots_sf))[, 1]
plots_sf$latitude <- st_coordinates(st_centroid(plots_sf))[, 2]
plots <- RawPlots(plots_sf) # Users should know year, plot size, inventory year beforehand for manual entry if ever missing in the shapefiles'attributes


## Remote deforested plots until year of map epoch and assign biomes/eco-regins
plots1 <- Deforested(plots,flDir,mapYear)
plots2 <- BiomePair(plots)
