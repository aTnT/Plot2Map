% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/UncertaintyAdvanced.R
\name{fitResidualVariogram}
\alias{fitResidualVariogram}
\title{Fit Variogram to Residuals After Bias Modeling}
\usage{
fitResidualVariogram(
  bias_data,
  map_sd_raster,
  model = "Sph",
  cutoff = 50,
  width = cutoff/15,
  psill = 3,
  range = 10,
  nugget = 4,
  coord_cols = c("lon", "lat"),
  crs = "EPSG:4326",
  remove_outliers = TRUE,
  plot = TRUE
)
}
\arguments{
\item{bias_data}{A data.frame with plot locations and bias modeling results.
Must contain columns: \code{bias} (observed bias), \code{biasPred} (predicted bias
from \code{trainBiasModel()}), coordinates (lon/lat or x/y), and will be joined
with SD values from \code{map_sd_raster}.}

\item{map_sd_raster}{SpatRaster containing pixel-level standard deviation of AGB
(Mg/ha). Used to scale residuals: resid = (bias - biasPred) / sd.}

\item{model}{Character. Variogram model type to fit. Options: "Sph" (Spherical,
default), "Exp" (Exponential), "Gau" (Gaussian), "Mat" (Matern). See
\code{gstat::vgm()} for details.}

\item{cutoff}{Numeric. Maximum distance in kilometers for variogram calculation.
Default: 50. Should be roughly half the maximum distance between plots.
The function automatically converts to meters after UTM transformation.}

\item{width}{Numeric. Width of distance bins in kilometers for empirical variogram.
Default: \code{cutoff/15}. Smaller values give more detail but more noise.}

\item{psill}{Numeric. Initial partial sill for variogram fitting. Default: 3.
Adjust based on variance of scaled residuals.}

\item{range}{Numeric. Initial range parameter in kilometers. Default: 10.
Represents distance at which correlation becomes negligible.}

\item{nugget}{Numeric. Initial nugget (y-intercept) for variogram. Default: 4.
Represents measurement error and micro-scale variation.}

\item{coord_cols}{Character vector of length 2. Column names for coordinates in
\code{bias_data}. Default: \code{c("lon", "lat")}. Use \code{c("x", "y")} if
data are already projected.}

\item{crs}{Character or numeric. Coordinate reference system for \code{bias_data}.
Default: "EPSG:4326" (WGS84). Must match \code{map_sd_raster} CRS or be
transformable to it.}

\item{remove_outliers}{Logical. Should extreme residuals (|resid| > 3) be removed
before variogram fitting? Default: TRUE. Helps prevent fitting issues.}

\item{plot}{Logical. Should a diagnostic plot be generated? Default: TRUE. Shows
empirical variogram points and fitted model curve.}
}
\value{
A list with class "residualVariogram" containing:
\describe{
\item{variogram_model}{gstat vgm object with fitted variogram parameters}
\item{empirical_variogram}{gstat variogram object with empirical semivariances}
\item{residuals}{data.frame with columns: coordinates, bias, biasPred, sd,
resid0 (raw residuals), resid (scaled residuals)}
\item{resid_sf}{sf object with residuals (used for variogram fitting)}
\item{fit_quality}{data.frame with fitting diagnostics: SSErr (sum of squared
errors), RMSE, R2 (pseudo-R²)}
\item{n_obs}{Integer. Number of observations used in fitting}
\item{n_removed}{Integer. Number of outliers removed (if remove_outliers=TRUE)}
\item{plot}{ggplot object if plot=TRUE, NULL otherwise}
}
}
\description{
Fits a variogram model to the scaled residuals from bias modeling to characterize
spatial autocorrelation in the remaining prediction errors. This is a critical step
for uncertainty quantification as it allows proper aggregation of standard errors
accounting for spatial correlation.
}
\details{
This function implements a residual variogram fitting approach with the following workflow:

\enumerate{
\item Extract SD values at plot locations from \code{map_sd_raster}
\item Calculate raw residuals: resid0 = bias - biasPred
\item Scale residuals by map SD: resid = resid0 / sd
\item Optionally remove outliers (|resid| > 3)
\item Convert to sf object for gstat
\item Fit empirical variogram with \code{gstat::variogram()}
\item Fit theoretical variogram model with \code{gstat::fit.variogram()}
}

\strong{Scaled residuals:} Scaling by SD is critical because it standardizes
residuals to unitless values, allowing variogram fitting across regions with
different absolute error magnitudes. The fitted variogram will be used to
create correlation matrices for uncertainty aggregation.

\strong{Model selection:} The default "Sph" (Spherical) model is appropriate for
most ecological data as it reaches a finite sill at a defined range. Use "Exp"
(Exponential) if correlation decays more gradually, or "Gau" (Gaussian) for very
smooth spatial processes.

\strong{Initial parameters:} The psill, range, and nugget parameters are starting
values for nonlinear optimization. Poor initial values can lead to convergence
issues. Inspect the empirical variogram first to choose reasonable starting values.
}
\examples{
\dontrun{
# Assuming you've run bias modeling workflow:
# 1. Extract covariates and calculate bias
bias_data <- extractBiasCovariates(
  plot_data = plots,
  map_agb = agb_map,
  map_sd = sd_map,
  covariates = list(height = height_raster, treecover = tc_raster)
)

# 2. Train bias model
bias_model <- trainBiasModel(
  bias_data = bias_data,
  predictors = c("map", "sd", "height", "treecover"),
  cv_folds = 10
)

# 3. Add predictions to bias_data
bias_data$biasPred <- predict(bias_model$model, data = bias_data)

# 4. Fit residual variogram
vgm_fit <- fitResidualVariogram(
  bias_data = bias_data,
  map_sd_raster = sd_map,
  model = "Sph",
  cutoff = 50,
  psill = 3,
  range = 10,
  nugget = 4,
  coord_cols = c("x", "y"),
  crs = "EPSG:4326"
)

# Inspect results
print(vgm_fit$variogram_model)
print(vgm_fit$fit_quality)
print(vgm_fit$plot)

# Check residual distribution
hist(vgm_fit$residuals$resid, main = "Scaled Residuals")
summary(vgm_fit$residuals$resid)
}

}
\references{
Araza, A., de Bruin, S., Herold, M., Quegan, S., Labrière, N., Rodriguez-Veiga, P.,
... & Burt, A. (2022). A comprehensive framework for assessing the accuracy and
uncertainty of global above-ground biomass maps. Remote Sensing of Environment, 272, 112917.

Christensen, W. F. (2011). Filtered kriging for spatial data with heterogeneous
measurement error variances. Biometrics, 67(3), 947-957.
}
\seealso{
\code{\link{trainBiasModel}} for bias model training,
\code{\link{discountVariogram}} for variogram nugget adjustment,
\code{\link{aggregateUncertainty}} for spatial uncertainty aggregation
}
