<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Advanced Uncertainty Quantification with Spatial Correlation • Plot2Map</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced Uncertainty Quantification with Spatial Correlation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Plot2Map</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/introduction.html">Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/plot-data-preparation.html">Plot data preparation</a></li>
    <li><a class="dropdown-item" href="../articles/bias-modeling.html">Bias Modeling and Correction for AGB Maps</a></li>
    <li><a class="dropdown-item" href="../articles/als-lidar-validation.html">Validating AGB Maps with Airborne LiDAR Data</a></li>
    <li><a class="dropdown-item" href="../articles/advanced-uncertainty.html">Advanced Uncertainty Quantification with Spatial Correlation</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Advanced Uncertainty Quantification with Spatial Correlation</h1>
            
      

      <div class="d-none name"><code>advanced-uncertainty.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette continues from <code><a href="../articles/bias-modeling.html">vignette("bias-modeling")</a></code>
and demonstrates how to properly quantify uncertainty in regional
biomass estimates. The workflow follows the geostatistical approach from
<a href="https://doi.org/10.1016/j.rse.2022.112917" class="external-link">Araza et
al. (2022)</a> and the Mexico demo notebook.</p>
<p>The key insight is that <strong>assuming pixel independence
underestimates uncertainty</strong> because spatial correlation is
ignored.</p>
<div class="section level3">
<h3 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h3>
<p>Complete the bias modeling workflow first. You should have these
objects:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># From bias-modeling.Rmd:</span></span>
<span><span class="co"># - AGBdata01: aggregated plot data from invDasymetry() WITH varPlot column</span></span>
<span><span class="co">#              (requires running Step 1.3: calculateTotalUncertainty BEFORE invDasymetry)</span></span>
<span><span class="co"># - bias_data: data.frame with plot-level bias and covariates (x, y, bias, map, sd, ...)</span></span>
<span><span class="co"># - bias_model: trained Random Forest model from trainBiasModel()</span></span>
<span><span class="co"># - agb_map_aligned: original AGB map (aligned to covariates)</span></span>
<span><span class="co"># - sd_map: pixel-level uncertainty map (SD in Mg/ha)</span></span>
<span><span class="co"># - map_adjusted: bias-corrected AGB map from adjustMapBias()</span></span>
<span><span class="co"># - covariates_stack: environmental covariates from spatialcovariates</span></span>
<span></span>
<span><span class="co"># IMPORTANT: AGBdata01 must have varPlot column from Step 1.3 in bias-modeling.Rmd</span></span>
<span><span class="co"># If varPlot is missing, go back and run Step 1.3: calculateTotalUncertainty() before invDasymetry()</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="why-spatial-correlation-matters">Why Spatial Correlation Matters<a class="anchor" aria-label="anchor" href="#why-spatial-correlation-matters"></a>
</h3>
<p><strong>Naive approach (independence assumption):</strong> <span class="math display">\[\text{SD}_{\text{independent}} = \sqrt{\sum_i
\text{SD}_i^2}\]</span></p>
<p><strong>Correct approach (with spatial correlation):</strong> <span class="math display">\[\text{SD}_{\text{correlated}} = \sqrt{\sum_i
\sum_j \text{SD}_i \times \text{SD}_j \times \rho_{ij}}\]</span></p>
<p>where <span class="math inline">\(\rho_{ij}\)</span> is the spatial
correlation between pixels derived from a variogram model.</p>
<p>In the Mexico demo, accounting for spatial correlation increased the
uncertainty estimate from 31.6 Pg to 277.9 Pg - nearly 9x larger!</p>
</div>
</div>
<div class="section level2">
<h2 id="step-1-prepare-residuals-for-variogram-fitting">Step 1: Prepare Residuals for Variogram Fitting<a class="anchor" aria-label="anchor" href="#step-1-prepare-residuals-for-variogram-fitting"></a>
</h2>
<p>First, add model predictions to <code>bias_data</code> and calculate
scaled residuals:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add predictions to bias_data</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">bias_model</span><span class="op">$</span><span class="va">method</span> <span class="op">==</span> <span class="st">"ranger"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">bias_data</span><span class="op">$</span><span class="va">biasPred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">bias_model</span><span class="op">$</span><span class="va">model</span>, data <span class="op">=</span> <span class="va">bias_data</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">bias_data</span><span class="op">$</span><span class="va">biasPred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">bias_model</span><span class="op">$</span><span class="va">model</span>, newdata <span class="op">=</span> <span class="va">bias_data</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Calculate raw residuals (bias - predicted bias)</span></span>
<span><span class="va">bias_data</span><span class="op">$</span><span class="va">resid0</span> <span class="op">&lt;-</span> <span class="va">bias_data</span><span class="op">$</span><span class="va">bias</span> <span class="op">-</span> <span class="va">bias_data</span><span class="op">$</span><span class="va">biasPred</span></span>
<span></span>
<span><span class="co"># Scale residuals by map SD (critical step!)</span></span>
<span><span class="co"># This standardizes residuals across regions with different error magnitudes</span></span>
<span><span class="va">bias_data</span><span class="op">$</span><span class="va">resid</span> <span class="op">&lt;-</span> <span class="va">bias_data</span><span class="op">$</span><span class="va">resid0</span> <span class="op">/</span> <span class="va">bias_data</span><span class="op">$</span><span class="va">sd</span></span>
<span></span>
<span><span class="co"># Remove infinite values (from zero SD)</span></span>
<span><span class="va">bias_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">bias_data</span>, <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">resid</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check distribution</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">bias_data</span><span class="op">$</span><span class="va">resid</span>, main <span class="op">=</span> <span class="st">"Scaled AGB Residuals"</span>, xlab <span class="op">=</span> <span class="st">"Scaled residual"</span><span class="op">)</span></span></code></pre></div>
<p><strong>Why scale by SD?</strong> Scaling standardizes residuals to
unitless values, allowing variogram fitting across regions with
different absolute error magnitudes. The fitted variogram describes the
spatial correlation structure of <em>relative</em> errors.</p>
</div>
<div class="section level2">
<h2 id="step-2-fit-residual-variogram">Step 2: Fit Residual Variogram<a class="anchor" aria-label="anchor" href="#step-2-fit-residual-variogram"></a>
</h2>
<p>Fit a variogram to the scaled residuals to characterize spatial
autocorrelation.</p>
<p><strong>Important</strong>: Reliable variogram fitting requires: - At
least 30-50 plots (more is better) - Good spatial distribution across
the study area - Sufficient distance range between plots</p>
<p>With fewer plots, variogram fitting may be unstable. The Spain
example in the bias-modeling vignette provides ~500 aggregated grid
cells, which is sufficient for reliable variogram estimation.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://aTnT.github.io/Plot2Map/" class="external-link">Plot2Map</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># First, examine your scaled residuals to choose appropriate initial parameters</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Scaled residual variance:"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">bias_data</span><span class="op">$</span><span class="va">resid</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Scaled residual range:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">bias_data</span><span class="op">$</span><span class="va">resid</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co"># Scaled residual variance: 97.76873 </span></span>
<span><span class="co"># Scaled residual range: -82.82981 449.4687 </span></span>
<span></span>
<span><span class="co"># IMPORTANT: Initial psill and nugget should be based on the VARIANCE of scaled residuals</span></span>
<span><span class="co"># If var(resid) ≈ 0.5, use psill ≈ 0.3, nugget ≈ 0.2</span></span>
<span><span class="co"># If var(resid) ≈ 1.0, use psill ≈ 0.6, nugget ≈ 0.4</span></span>
<span></span>
<span><span class="co"># Calculate suggested initial values</span></span>
<span><span class="va">resid_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">bias_data</span><span class="op">$</span><span class="va">resid</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">suggested_psill</span> <span class="op">&lt;-</span> <span class="va">resid_var</span> <span class="op">*</span> <span class="fl">0.6</span></span>
<span><span class="va">suggested_nugget</span> <span class="op">&lt;-</span> <span class="va">resid_var</span> <span class="op">*</span> <span class="fl">0.4</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Suggested initial psill:"</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="va">suggested_psill</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Suggested initial nugget:"</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="va">suggested_nugget</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co"># Suggested initial psill: 58.661 </span></span>
<span><span class="co"># Suggested initial nugget: 39.107 </span></span>
<span></span>
<span><span class="co"># Fit variogram to scaled residuals</span></span>
<span><span class="co"># Note: fitResidualVariogram() transforms geographic coords to UTM for accurate</span></span>
<span><span class="co"># distance calculations. All distance parameters (cutoff, width, range) are in km.</span></span>
<span><span class="va">vgm_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitResidualVariogram.html">fitResidualVariogram</a></span><span class="op">(</span></span>
<span>  bias_data <span class="op">=</span> <span class="va">bias_data</span>,</span>
<span>  map_sd_raster <span class="op">=</span> <span class="va">sd_map</span>,</span>
<span>  model <span class="op">=</span> <span class="st">"Sph"</span>,           <span class="co"># Spherical model</span></span>
<span>  cutoff <span class="op">=</span> <span class="fl">500</span>,            <span class="co"># Maximum distance in km (adjust to ~half study extent)</span></span>
<span>  width <span class="op">=</span> <span class="fl">33</span>,              <span class="co"># Bin width in km (cutoff / 15)</span></span>
<span>  psill <span class="op">=</span> <span class="va">suggested_psill</span>, <span class="co"># Initial partial sill based on residual variance</span></span>
<span>  range <span class="op">=</span> <span class="fl">100</span>,             <span class="co"># Initial range in km</span></span>
<span>  nugget <span class="op">=</span> <span class="va">suggested_nugget</span>, <span class="co"># Initial nugget based on residual variance</span></span>
<span>  coord_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>,</span>
<span>  crs <span class="op">=</span> <span class="st">"EPSG:4326"</span>,</span>
<span>  remove_outliers <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  plot <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View fitted model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">vgm_fit</span><span class="op">$</span><span class="va">variogram_model</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Examine fit quality</span></span>
<span><span class="co"># R² should be positive; negative R² indicates poor fit - adjust parameters</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">vgm_fit</span><span class="op">$</span><span class="va">fit_quality</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#   model     psill  range</span></span>
<span><span class="co"># 1   Nug 0.5565663      0</span></span>
<span><span class="co"># 2   Sph 0.2164059 154476</span></span>
<span><span class="co">#         SSErr       RMSE        R2</span></span>
<span><span class="co"># 1 0.006368057 0.01995003 0.8295572</span></span></code></pre></div>
<div class="section level3">
<h3 id="understanding-variogram-parameters">Understanding Variogram Parameters<a class="anchor" aria-label="anchor" href="#understanding-variogram-parameters"></a>
</h3>
<ul>
<li>
<strong>Nugget</strong>: Variance at zero distance (measurement
error + micro-scale variation)</li>
<li>
<strong>Partial sill (psill)</strong>: Additional variance explained
by spatial structure</li>
<li>
<strong>Total sill</strong>: Nugget + psill (total variance at large
distances)</li>
<li>
<strong>Range</strong>: Distance at which correlation becomes
negligible (varies by study area)</li>
</ul>
</div>
<div class="section level3">
<h3 id="interpreting-the-variogram">Interpreting the Variogram<a class="anchor" aria-label="anchor" href="#interpreting-the-variogram"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vgm</span> <span class="op">&lt;-</span> <span class="va">vgm_fit</span><span class="op">$</span><span class="va">variogram_model</span></span>
<span></span>
<span><span class="co"># Extract parameters (range is in meters after UTM conversion)</span></span>
<span><span class="va">nugget_val</span> <span class="op">&lt;-</span> <span class="va">vgm</span><span class="op">$</span><span class="va">psill</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">sill_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">vgm</span><span class="op">$</span><span class="va">psill</span><span class="op">)</span></span>
<span><span class="va">range_val</span> <span class="op">&lt;-</span> <span class="va">vgm</span><span class="op">$</span><span class="va">range</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">/</span> <span class="fl">1000</span>  <span class="co"># Convert meters to km</span></span>
<span></span>
<span><span class="co"># Nugget-to-sill ratio</span></span>
<span><span class="va">nugget_ratio</span> <span class="op">&lt;-</span> <span class="va">nugget_val</span> <span class="op">/</span> <span class="va">sill_val</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Nugget-to-sill ratio:"</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="va">nugget_ratio</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co"># &lt; 0.25: Strong spatial structure</span></span>
<span><span class="co"># &gt; 0.75: Weak spatial structure (mostly random noise)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Effective range:"</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="va">range_val</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"km\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Nugget-to-sill ratio: 0.72 </span></span>
<span><span class="co"># Effective range: 154.5 km</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="step-3-discount-variogram-for-plot-measurement-error">Step 3: Discount Variogram for Plot Measurement Error<a class="anchor" aria-label="anchor" href="#step-3-discount-variogram-for-plot-measurement-error"></a>
</h2>
<p>The variogram nugget includes both map error and plot measurement
error. We discount the nugget to isolate the map error component:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Merge varPlot from AGBdata01 into bias_data</span></span>
<span><span class="co"># invDasymetry already calculated varPlot when we used aggr = 0.1</span></span>
<span><span class="va">bias_data</span><span class="op">$</span><span class="va">varPlot</span> <span class="op">&lt;-</span> <span class="va">AGBdata01</span><span class="op">$</span><span class="va">varPlot</span><span class="op">[</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">bias_data</span><span class="op">$</span><span class="va">x</span>, <span class="va">bias_data</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">AGBdata01</span><span class="op">$</span><span class="va">x</span>, <span class="va">AGBdata01</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Calculate varMap (map pixel variance)</span></span>
<span><span class="va">bias_data</span><span class="op">$</span><span class="va">varMap</span> <span class="op">&lt;-</span> <span class="va">bias_data</span><span class="op">$</span><span class="va">sd</span><span class="op">^</span><span class="fl">2</span></span>
<span></span>
<span><span class="co"># Verify required columns</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Required columns present:"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"varPlot"</span>, <span class="st">"varMap"</span><span class="op">)</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">bias_data</span><span class="op">)</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Non-NA varPlot values:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">bias_data</span><span class="op">$</span><span class="va">varPlot</span><span class="op">)</span><span class="op">)</span>, <span class="st">"of"</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">bias_data</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Discount variogram</span></span>
<span><span class="va">vgm_discounted</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/discountVariogram.html">discountVariogram</a></span><span class="op">(</span></span>
<span>  variogram_fit <span class="op">=</span> <span class="va">vgm_fit</span>,</span>
<span>  plot_data <span class="op">=</span> <span class="va">bias_data</span>,</span>
<span>  filter_iqr <span class="op">=</span> <span class="cn">TRUE</span>,       <span class="co"># IQR filtering (25-75th percentile)</span></span>
<span>  iqr_mult <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>  transfer_negative <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  plot <span class="op">=</span> <span class="cn">FALSE</span>  <span class="co"># Don't plot to screen, will save to PNG</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View discount factor</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Discount factor:"</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="va">vgm_discounted</span><span class="op">$</span><span class="va">discount_factor</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Original nugget:"</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="va">vgm_discounted</span><span class="op">$</span><span class="va">nugget_original</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Discounted nugget:"</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="va">vgm_discounted</span><span class="op">$</span><span class="va">nugget_discounted</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare variograms</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">vgm_discounted</span><span class="op">$</span><span class="va">original_variogram</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">vgm_discounted</span><span class="op">$</span><span class="va">discounted_variogram</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Discount factor: 0.0848</span></span>
<span><span class="co"># Original nugget: 0.557</span></span>
<span><span class="co"># Discounted nugget: 0.472</span></span>
<span><span class="co">#   model     psill  range</span></span>
<span><span class="co"># 1   Nug 0.5565663      0</span></span>
<span><span class="co"># 2   Sph 0.2164059 154476</span></span>
<span><span class="co">#   model     psill  range</span></span>
<span><span class="co"># 1   Nug 0.4717966      0</span></span>
<span><span class="co"># 2   Sph 0.2164059 154476</span></span>
<span></span>
<span><span class="co"># Plot comparison</span></span>
<span><span class="va">maxdist_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">vgm_fit</span><span class="op">$</span><span class="va">empirical_variogram</span><span class="op">$</span><span class="va">dist</span><span class="op">)</span></span>
<span><span class="va">vgm_orig_fitted</span> <span class="op">&lt;-</span> <span class="fu">gstat</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/gstat/reference/variogramLine.html" class="external-link">variogramLine</a></span><span class="op">(</span><span class="va">vgm_discounted</span><span class="op">$</span><span class="va">original_variogram</span>,</span>
<span>                                        maxdist <span class="op">=</span> <span class="va">maxdist_m</span><span class="op">)</span></span>
<span><span class="va">vgm_disc_fitted</span> <span class="op">&lt;-</span> <span class="fu">gstat</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/gstat/reference/variogramLine.html" class="external-link">variogramLine</a></span><span class="op">(</span><span class="va">vgm_discounted</span><span class="op">$</span><span class="va">discounted_variogram</span>,</span>
<span>                                        maxdist <span class="op">=</span> <span class="va">maxdist_m</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vgm_fit</span><span class="op">$</span><span class="va">empirical_variogram</span><span class="op">$</span><span class="va">dist</span> <span class="op">/</span> <span class="fl">1000</span>,</span>
<span>     <span class="va">vgm_fit</span><span class="op">$</span><span class="va">empirical_variogram</span><span class="op">$</span><span class="va">gamma</span>,</span>
<span>     pch <span class="op">=</span> <span class="fl">20</span>, cex <span class="op">=</span> <span class="fl">1.5</span>, col <span class="op">=</span> <span class="st">"gray50"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Distance (km)"</span>, ylab <span class="op">=</span> <span class="st">"Semivariance"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Original vs Discounted Variogram"</span>,</span>
<span>     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">vgm_fit</span><span class="op">$</span><span class="va">empirical_variogram</span><span class="op">$</span><span class="va">gamma</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">vgm_disc_fitted</span><span class="op">$</span><span class="va">dist</span> <span class="op">/</span> <span class="fl">1000</span>,</span>
<span>      <span class="va">vgm_disc_fitted</span><span class="op">$</span><span class="va">gamma</span>,</span>
<span>      col <span class="op">=</span> <span class="st">"blue"</span>, lwd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">vgm_orig_fitted</span><span class="op">$</span><span class="va">dist</span> <span class="op">/</span> <span class="fl">1000</span>,</span>
<span>      <span class="va">vgm_orig_fitted</span><span class="op">$</span><span class="va">gamma</span>,</span>
<span>      col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">3</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"bottomright"</span>,</span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Empirical"</span>, <span class="st">"Original (before discount)"</span>, <span class="st">"Discounted (after discount)"</span><span class="op">)</span>,</span>
<span>       pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>       col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gray50"</span>, <span class="st">"red"</span>, <span class="st">"blue"</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="variogram_discounted_iberia.png" alt="Original vs Discounted Variogram for Iberian Peninsula"><div class="figcaption">Original vs Discounted Variogram for Iberian
Peninsula</div>
</div>
<div class="section level3">
<h3 id="understanding-discounting">Understanding Discounting<a class="anchor" aria-label="anchor" href="#understanding-discounting"></a>
</h3>
<p>The discount factor is calculated as:
<code>mean(varPlot / varMap²)</code></p>
<p>This represents the proportion of the nugget attributable to plot
measurement error rather than map error. After discounting: - Large
discount (&gt; 0.5): Most nugget was plot error - Small discount (&lt;
0.2): Most nugget was map error</p>
</div>
</div>
<div class="section level2">
<h2 id="step-4-create-correlation-matrix">Step 4: Create Correlation Matrix<a class="anchor" aria-label="anchor" href="#step-4-create-correlation-matrix"></a>
</h2>
<p>Build a correlation matrix from the discounted variogram for focal
aggregation:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The aggregateUncertainty function creates this internally, but here's the logic:</span></span>
<span><span class="co"># Correlation: rho(h) = 1 - gamma(h) / sill</span></span>
<span></span>
<span><span class="co"># For a focal window at resolution 0.1° (~10 km):</span></span>
<span><span class="co"># - Create distance grid within window</span></span>
<span><span class="co"># - Convert distances to semivariances using variogram</span></span>
<span><span class="co"># - Convert semivariances to correlations</span></span>
<span></span>
<span><span class="co"># The matrix size depends on the variogram range</span></span>
<span><span class="co"># For range ~8 km and 0.1° resolution, window covers ~2-3 cells in each direction</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-5-aggregate-uncertainty-with-spatial-correlation">Step 5: Aggregate Uncertainty with Spatial Correlation<a class="anchor" aria-label="anchor" href="#step-5-aggregate-uncertainty-with-spatial-correlation"></a>
</h2>
<p>Apply the discounted variogram to aggregate pixel-level uncertainty
at the regional scale:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># First, align sd_map with covariates_stack for consistent extents/resolution</span></span>
<span><span class="va">sd_map_aligned</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/resample.html" class="external-link">resample</a></span><span class="op">(</span><span class="va">sd_map</span>, <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"tcc2010"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                                   method <span class="op">=</span> <span class="st">"bilinear"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Aggregate uncertainty accounting for spatial correlation</span></span>
<span><span class="co"># This uses focal window aggregation with correlation weights</span></span>
<span><span class="va">uncertainty_agg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aggregateUncertainty.html">aggregateUncertainty</a></span><span class="op">(</span></span>
<span>  sd_raster <span class="op">=</span> <span class="va">sd_map_aligned</span>,</span>
<span>  variogram_model <span class="op">=</span> <span class="va">vgm_discounted</span>,</span>
<span>  resolution <span class="op">=</span> <span class="fl">0.1</span>,        <span class="co"># Aggregation resolution in degrees (~10 km)</span></span>
<span>  forest_mask <span class="op">=</span> <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"tcc2010"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  return_comparison <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  scale_factor <span class="op">=</span> <span class="fl">10000</span>,    <span class="co"># Convert 0.1° to hectares (100m pixels)</span></span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Regional SD with spatial correlation</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Regional SD (with correlation):"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">uncertainty_agg</span><span class="op">$</span><span class="va">regional_sd_correlated</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span>, <span class="st">"Mg\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Regional SD assuming independence</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Regional SD (independence):"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">uncertainty_agg</span><span class="op">$</span><span class="va">regional_sd_independent</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span>, <span class="st">"Mg\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Correlation increases uncertainty by this factor:</span></span>
<span><span class="va">correlation_ratio</span> <span class="op">&lt;-</span> <span class="va">uncertainty_agg</span><span class="op">$</span><span class="va">regional_sd_correlated</span> <span class="op">/</span> <span class="va">uncertainty_agg</span><span class="op">$</span><span class="va">regional_sd_independent</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Correlation ratio:"</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="va">correlation_ratio</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"x\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Spatial correlation increases uncertainty by"</span>,</span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">correlation_ratio</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"%\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Regional SD (with correlation): 57,993,482 Mg</span></span>
<span><span class="co"># Regional SD (independence): 43,911,980 Mg</span></span>
<span><span class="co"># Correlation ratio: 1.32 x</span></span>
<span><span class="co"># Spatial correlation increases uncertainty by 32.1 %</span></span>
<span></span>
<span><span class="co"># Visualize aggregated SD</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">uncertainty_agg</span><span class="op">$</span><span class="va">aggregated_sd_raster</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Aggregated SD (Mg) - With Spatial Correlation"</span>,</span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">terrain.colors</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="agg_spa_corr_iberia.png" alt="Aggregated SD (Mg) - With Spatial Correlation for Iberian Peninsula"><div class="figcaption">Aggregated SD (Mg) - With Spatial Correlation
for Iberian Peninsula</div>
</div>
<div class="section level3">
<h3 id="how-aggregation-works">How Aggregation Works<a class="anchor" aria-label="anchor" href="#how-aggregation-works"></a>
</h3>
<p>The following approach is used:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Create correlation matrix</strong> from variogram using
Haversine distances</li>
<li>
<strong>Apply focal aggregation</strong>: For each pixel, calculate
weighted sum of SD products: <span class="math display">\[\text{sumErr}
= \sum_i \text{SD}_{\text{center}} \times \text{SD}_i \times
\rho_i\]</span>
</li>
<li>
<strong>Regional total</strong>: <span class="math inline">\(\text{SD}_{\text{total}} = \sqrt{\sum
\text{sumErr}} \times \text{scale\_factor}\)</span>
</li>
</ol>
<p>The scale factor (10000) converts from 0.1° grid cells to hectares
based on 100m pixel resolution.</p>
</div>
<div class="section level3">
<h3 id="key-findings">Key Findings<a class="anchor" aria-label="anchor" href="#key-findings"></a>
</h3>
<p>The 32% increase in uncertainty when accounting for spatial
correlation is substantial and demonstrates that:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Map errors are spatially correlated</strong> at distances up
to ~155 km (the variogram range)</li>
<li>
<strong>The independence assumption is invalid</strong> - treating
pixels as independent underestimates uncertainty</li>
<li>
<strong>Proper uncertainty quantification requires geostatistical
methods</strong> that account for spatial structure</li>
</ol>
<p>This result aligns with findings from Araza et al. (2022), who showed
that ignoring spatial correlation can lead to severe underestimation of
regional biomass uncertainty. While our 32% increase is more moderate
than the Mexico demo’s 9x factor, it reflects:</p>
<ul>
<li>
<strong>Different spatial scales</strong>: Spain (Iberian Peninsula)
is smaller than Mexico</li>
<li>
<strong>Different forest types</strong>: Temperate forests have
different error structures than tropical</li>
<li>
<strong>Moderate spatial correlation</strong>: Our nugget-to-sill
ratio of 0.72 indicates weaker spatial structure than Mexico</li>
</ul>
</div>
<div class="section level3">
<h3 id="implications-for-carbon-reporting">Implications for Carbon Reporting<a class="anchor" aria-label="anchor" href="#implications-for-carbon-reporting"></a>
</h3>
<p>For national greenhouse gas inventories and REDD+ MRV systems, these
results show that:</p>
<ul>
<li>Pixel-based uncertainty estimates must be propagated with spatial
correlation</li>
<li>Simply summing pixel-level SDs in quadrature will underestimate
regional uncertainty</li>
<li>The variogram-based approach provides defensible uncertainty bounds
for policy decisions</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="step-6-calculate-regional-totals-with-confidence-intervals">Step 6: Calculate Regional Totals with Confidence Intervals<a class="anchor" aria-label="anchor" href="#step-6-calculate-regional-totals-with-confidence-intervals"></a>
</h2>
<p>Combine everything to report bias-adjusted totals with proper
uncertainty:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate regional totals for both default and adjusted maps</span></span>
<span><span class="va">regional_totals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/biasAdjustedTotal.html">biasAdjustedTotal</a></span><span class="op">(</span></span>
<span>  map_agb_default <span class="op">=</span> <span class="va">agb_map_aligned</span>,</span>
<span>  map_agb_adjusted <span class="op">=</span> <span class="va">map_adjusted</span>,</span>
<span>  aggregated_uncertainty <span class="op">=</span> <span class="va">uncertainty_agg</span>,</span>
<span>  forest_mask <span class="op">=</span> <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"tcc2010"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  confidence_level <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>  scale_factor <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>  return_details <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">regional_totals</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check if bias correction is statistically significant</span></span>
<span><span class="va">overlap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">regional_totals</span>, <span class="st">"uncertainty_overlap"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">overlap</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nConfidence intervals do NOT overlap - bias correction is statistically significant\n"</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nConfidence intervals overlap - bias correction is NOT statistically significant\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Bias correction effect</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nBias correction effect:"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">regional_totals</span>, <span class="st">"bias_correction_effect"</span><span class="op">)</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span>, <span class="st">"Mg\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Percent change:"</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">regional_totals</span>, <span class="st">"percent_change"</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"%\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#        map_type   total_Mg    sd_Mg cv_percent   ci_lower   ci_upper confidence_level n_cells mean_agb_Mg_ha</span></span>
<span><span class="co"># 1       default 2275748993 57993482   2.548325 2162083858 2389414128             0.95    4776       47.64969</span></span>
<span><span class="co"># 2 bias_adjusted 2411995142 57993482   2.404378 2298330006 2525660277             0.95    4776       50.50241</span></span>
<span><span class="co">#   sd_mean_Mg_ha</span></span>
<span><span class="co"># 1      1.214269</span></span>
<span><span class="co"># 2      1.214269</span></span>
<span></span>
<span><span class="co"># Confidence intervals overlap - bias correction is NOT statistically significant</span></span>
<span></span>
<span><span class="co"># Bias correction effect: 136,246,149 Mg</span></span>
<span><span class="co"># Percent change: 5.99 %</span></span></code></pre></div>
<div class="section level3">
<h3 id="interpreting-the-results">Interpreting the Results<a class="anchor" aria-label="anchor" href="#interpreting-the-results"></a>
</h3>
<p><strong>Regional Biomass Estimates for Iberian
Peninsula:</strong></p>
<ul>
<li>
<strong>Default map</strong>: 2.28 Pg (95% CI: 2.16 - 2.39 Pg), CV =
2.5%</li>
<li>
<strong>Bias-adjusted map</strong>: 2.41 Pg (95% CI: 2.30 - 2.53
Pg), CV = 2.4%</li>
<li>
<strong>Bias correction effect</strong>: +136 Tg (6% increase)</li>
</ul>
<p><strong>Statistical Significance:</strong></p>
<p>The overlapping confidence intervals indicate that the bias
correction is not statistically significant at the 95% confidence level.
While the bias modeling detected systematic errors and increased the
estimate by 6%, the large uncertainty (±58 Tg) means we cannot conclude
with 95% confidence that the corrected map differs from the
original.</p>
<p><strong>Why is the CV relatively low (~2.5%)?</strong></p>
<p>The Iberian Peninsula shows lower relative uncertainty than many
tropical regions because:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Excellent plot coverage</strong>: 5,328 field plots
well-distributed across the region</li>
<li>
<strong>Homogeneous temperate forests</strong>: Less structural
complexity than tropical forests</li>
<li>
<strong>Consistent map performance</strong>: ESA CCI performs well
in temperate regions</li>
<li>
<strong>Moderate spatial correlation</strong>: Nugget-to-sill ratio
of 0.72 indicates weaker spatial structure</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="common-issues-and-solutions">Common Issues and Solutions<a class="anchor" aria-label="anchor" href="#common-issues-and-solutions"></a>
</h2>
<div class="section level3">
<h3 id="issue-singular-model-in-variogram-fit-warning">Issue: “Singular model in variogram fit” Warning<a class="anchor" aria-label="anchor" href="#issue-singular-model-in-variogram-fit-warning"></a>
</h3>
<p><strong>Cause</strong>: Initial parameters (psill, nugget) don’t
match the scale of your data</p>
<p><strong>Solution</strong>: Base initial parameters on residual
variance:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resid_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">bias_data</span><span class="op">$</span><span class="va">resid</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Use psill = resid_var * 0.6, nugget = resid_var * 0.4</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="issue-negative-r²-in-fit-quality">Issue: Negative R² in Fit Quality<a class="anchor" aria-label="anchor" href="#issue-negative-r%C2%B2-in-fit-quality"></a>
</h3>
<p><strong>Cause</strong>: Poor variogram fit - the model is worse than
the mean</p>
<p><strong>Solutions</strong>: 1. Adjust cutoff to match your study
extent (~half the maximum distance) 2. Use data-driven initial
psill/nugget (see above) 3. Try different model types (“Exp”, “Gau”
instead of “Sph”) 4. Check if you have enough spatial spread in your
plots</p>
</div>
<div class="section level3">
<h3 id="issue-variogram-fitting-fails-completely">Issue: Variogram Fitting Fails Completely<a class="anchor" aria-label="anchor" href="#issue-variogram-fitting-fails-completely"></a>
</h3>
<p><strong>Possible causes</strong>: - Too few data points (need 30+
plots for reliable variograms) - Plots clustered in one area
(insufficient spatial spread) - Coordinates in wrong units or CRS</p>
<p><strong>Solution</strong>: Check empirical variogram first, ensure
good spatial coverage</p>
</div>
<div class="section level3">
<h3 id="issue-negative-nugget-after-discounting">Issue: Negative Nugget After Discounting<a class="anchor" aria-label="anchor" href="#issue-negative-nugget-after-discounting"></a>
</h3>
<p><strong>Solution</strong>: Use <code>transfer_negative = TRUE</code>
to redistribute to partial sill</p>
</div>
<div class="section level3">
<h3 id="issue-very-large-correlation-ratio-10">Issue: Very Large Correlation Ratio (&gt; 10)<a class="anchor" aria-label="anchor" href="#issue-very-large-correlation-ratio-10"></a>
</h3>
<p>This is expected when spatial correlation is strong. The Mexico demo
showed a ratio of ~8.8x. High ratios indicate: - Strong spatial
autocorrelation in map errors - Independence assumption would severely
underestimate uncertainty</p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li><p>Araza, A., et al. (2022). “A comprehensive framework for
assessing the accuracy and uncertainty of global above-ground biomass
maps.” <em>Remote Sensing of Environment</em>, 272, 112917.</p></li>
<li><p>Christensen, W.F. (2011). “Filtered kriging for spatial data with
heterogeneous measurement error variances.” <em>Biometrics</em>, 67(3),
947-957.</p></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/arnanaraza" class="external-link">Arnan Araza</a>, <a href="https://github.com/aTnT" class="external-link">André Tavares</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
