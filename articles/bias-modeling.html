<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Bias Modeling and Correction for AGB Maps • Plot2Map</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Bias Modeling and Correction for AGB Maps">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Plot2Map</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/introduction.html">Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/plot-data-preparation.html">Plot data preparation</a></li>
    <li><a class="dropdown-item" href="../articles/bias-modeling.html">Bias Modeling and Correction for AGB Maps</a></li>
    <li><a class="dropdown-item" href="../articles/advanced-uncertainty.html">Advanced Uncertainty Quantification with Spatial Correlation</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Bias Modeling and Correction for AGB Maps</h1>
            
      

      <div class="d-none name"><code>bias-modeling.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Above-ground biomass (AGB) maps derived from satellite remote sensing
are essential for monitoring forest carbon stocks and emissions.
However, these maps often contain systematic biases that vary spatially
and can be predicted using environmental covariates. This vignette
demonstrates how to use Plot2Map’s bias modeling functions to:</p>
<ol style="list-style-type: decimal">
<li>Quantify bias patterns in AGB maps using field plot data</li>
<li>Train Random Forest models to predict bias from environmental
covariates</li>
<li>Generate wall-to-wall bias correction maps</li>
<li>Adjust AGB maps to reduce systematic errors</li>
</ol>
<p>The bias modeling workflow is particularly valuable for:</p>
<ul>
<li>Improving regional carbon stock estimates</li>
<li>Understanding environmental drivers of map errors</li>
<li>Creating more accurate AGB products for policy and science</li>
<li>Quantifying uncertainty in bias-corrected maps</li>
</ul>
</div>
<div class="section level2">
<h2 id="theoretical-background">Theoretical Background<a class="anchor" aria-label="anchor" href="#theoretical-background"></a>
</h2>
<div class="section level3">
<h3 id="understanding-map-bias">Understanding Map Bias<a class="anchor" aria-label="anchor" href="#understanding-map-bias"></a>
</h3>
<p><strong>Bias</strong> is the systematic difference between map
predictions and true values. Unlike random errors, bias is predictable
and can be modeled. For AGB maps, bias often correlates with:</p>
<ul>
<li>
<strong>Forest structure</strong>: Dense forests may be
over/underestimated</li>
<li>
<strong>Topography</strong>: Slopes affect radar backscatter and
optical reflectance</li>
<li>
<strong>Climate</strong>: Precipitation and temperature influence
vegetation properties</li>
<li>
<strong>Land cover</strong>: Different forest types have different
error characteristics</li>
</ul>
</div>
<div class="section level3">
<h3 id="the-bias-modeling-approach">The Bias Modeling Approach<a class="anchor" aria-label="anchor" href="#the-bias-modeling-approach"></a>
</h3>
<p>Plot2Map uses a four-step workflow:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Extract bias</strong>: Calculate plot-level bias (plot AGB -
map AGB) and associated covariates</li>
<li>
<strong>Train model</strong>: Fit Random Forest to predict bias from
environmental variables</li>
<li>
<strong>Predict bias map</strong>: Apply model wall-to-wall to
generate bias correction surface</li>
<li>
<strong>Adjust map</strong>: Subtract predicted bias from original
map</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="required-data">Required Data<a class="anchor" aria-label="anchor" href="#required-data"></a>
</h2>
<p>Before starting, you need:</p>
<ol style="list-style-type: decimal">
<li>
<strong>AGB map</strong> (SpatRaster): Remote sensing-derived
biomass map (Mg/ha)</li>
<li>
<strong>Plot data</strong> (data.frame): Field measurements with
coordinates and AGB values</li>
<li>
<strong>Covariate rasters</strong> (SpatRaster stack): Environmental
predictors</li>
<li>
<strong>Forest mask</strong> (optional): Binary forest/non-forest
map</li>
</ol>
<div class="section level3">
<h3 id="example-data-structure">Example Data Structure<a class="anchor" aria-label="anchor" href="#example-data-structure"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot data should have:</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">plot_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   lon     lat  AGB_T_HA  varPlot  SIZE_HA</span></span>
<span><span class="co">#&gt;   -95.5   19.2  125.3    450      1.0</span></span>
<span><span class="co">#&gt;   -94.8   18.9  87.6     320      0.5</span></span>
<span></span>
<span><span class="co"># AGB map (example)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="va">agb_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="st">"path/to/agb_map.tif"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Covariate stack (example: elevation, precipitation, temperature)</span></span>
<span><span class="va">covariates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"elevation.tif"</span>, <span class="st">"precip.tif"</span>, <span class="st">"temp.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">covariates</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"elevation"</span>, <span class="st">"precipitation"</span>, <span class="st">"temperature"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Forest mask</span></span>
<span><span class="va">forest_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="st">"forest_mask.tif"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="step-1-1-define-study-region-and-load-libraries">Step 1.1 Define Study Region and Load Libraries<a class="anchor" aria-label="anchor" href="#step-1-1-define-study-region-and-load-libraries"></a>
</h2>
<p>First, define the study region and load required packages:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://aTnT.github.io/Plot2Map/" class="external-link">Plot2Map</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define study region (Iberian Peninsula)</span></span>
<span><span class="co"># This region has excellent plot coverage (~5,300 plots) in the Plot2Map::plots dataset</span></span>
<span><span class="co"># with good spatial distribution across ~900 x 800 km</span></span>
<span><span class="va">study_bbox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="op">-</span><span class="fl">9</span>, ymin <span class="op">=</span> <span class="fl">36</span>, xmax <span class="op">=</span> <span class="fl">4</span>, ymax <span class="op">=</span> <span class="fl">44</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-1-2-obtain-covariates">Step 1.2 Obtain Covariates<a class="anchor" aria-label="anchor" href="#step-1-2-obtain-covariates"></a>
</h2>
<p>You can automate covariate fetching using the <a href="https://atnt.github.io/spatialcovariates/" class="external-link"><code>spatialcovariates</code></a>
package:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install spatialcovariates (if not already installed)</span></span>
<span><span class="co"># devtools::install_github("aTnT/spatialcovariates")</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">spatialcovariates</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 1: Fetch AGB and SD from ESA CCI</span></span>
<span><span class="va">biomass_data</span> <span class="op">&lt;-</span> <span class="fu">getESACCIAGB</span><span class="op">(</span></span>
<span>  extent <span class="op">=</span> <span class="va">study_bbox</span>,</span>
<span>  year <span class="op">=</span> <span class="fl">2010</span>,</span>
<span>  resolution <span class="op">=</span> <span class="st">"10km"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">agb_map</span> <span class="op">&lt;-</span> <span class="va">biomass_data</span><span class="op">$</span><span class="va">agb</span>  <span class="co"># ESA CCI AGB</span></span>
<span><span class="va">sd_map</span> <span class="op">&lt;-</span> <span class="va">biomass_data</span><span class="op">$</span><span class="va">sd</span>    <span class="co"># ESA CCI SD</span></span>
<span></span>
<span><span class="co"># Step 2: Fetch environmental covariates (as a SpatRaster stack)</span></span>
<span><span class="va">covariates_stack</span> <span class="op">&lt;-</span> <span class="fu">getBiasCovariates</span><span class="op">(</span></span>
<span>  extent <span class="op">=</span> <span class="va">study_bbox</span>,</span>
<span>  year <span class="op">=</span> <span class="fl">2010</span>,</span>
<span>  resolution <span class="op">=</span> <span class="st">"10km"</span>,</span>
<span>  n_cores <span class="op">=</span> <span class="fl">4</span>  <span class="co"># Parallel downloads</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The stack contains all covariates:</span></span>
<span><span class="co"># tcc2010, treecover2000, elevation, slope, aspect, tri, tpi, roughness, biome, ifl</span></span>
<span><span class="co"># We'll extract these in Step 2</span></span></code></pre></div>
<p><strong>Alternative: Manual approach using
SDtileNames()</strong>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://aTnT.github.io/Plot2Map/" class="external-link">Plot2Map</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster" class="external-link">raster</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://had.co.nz/plyr" class="external-link">plyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Obtain SD raster from AGB product using SDtileNames()</span></span>
<span><span class="va">pt</span> <span class="op">&lt;-</span> <span class="fu">rasterToPoints</span><span class="op">(</span><span class="fu">sampleRandom</span><span class="op">(</span><span class="va">agb_map</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncell</a></span><span class="op">(</span><span class="va">agb_map</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.005</span>,</span>
<span>                                   asRaster <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, spatial <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">pol</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pt</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/MakeBlockPolygon.html">MakeBlockPolygon</a></span><span class="op">(</span><span class="va">pt</span><span class="op">@</span><span class="va">coords</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span>, <span class="va">pt</span><span class="op">@</span><span class="va">coords</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span>, <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">SD.tiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/ldply.html" class="external-link">ldply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">pol</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/SDtileNames.html">SDtileNames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, <span class="va">data.frame</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="op">-</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">sd_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">merge</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">SD.tiles</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">raster</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="va">study_region</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Manually load other covariates (height, treecover, slope, etc.)</span></span>
<span><span class="co"># ... (user provides their own covariate rasters)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-1-3-prepare-plot-data">Step 1.3 Prepare Plot Data<a class="anchor" aria-label="anchor" href="#step-1-3-prepare-plot-data"></a>
</h2>
<p>We’ll use the global field plot dataset included in Plot2Map,
filtered to the Iberian Peninsula where we have excellent plot coverage
(~5,300 plots well-distributed across the region).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load global plot database</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"plots"</span>, package <span class="op">=</span> <span class="st">"Plot2Map"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Filter plots to study region</span></span>
<span><span class="va">plot_data_raw</span> <span class="op">&lt;-</span> <span class="va">plots</span><span class="op">[</span></span>
<span>  <span class="va">plots</span><span class="op">$</span><span class="va">POINT_X</span> <span class="op">&gt;=</span> <span class="va">study_bbox</span><span class="op">[</span><span class="st">"xmin"</span><span class="op">]</span> <span class="op">&amp;</span></span>
<span>  <span class="va">plots</span><span class="op">$</span><span class="va">POINT_X</span> <span class="op">&lt;=</span> <span class="va">study_bbox</span><span class="op">[</span><span class="st">"xmax"</span><span class="op">]</span> <span class="op">&amp;</span></span>
<span>  <span class="va">plots</span><span class="op">$</span><span class="va">POINT_Y</span> <span class="op">&gt;=</span> <span class="va">study_bbox</span><span class="op">[</span><span class="st">"ymin"</span><span class="op">]</span> <span class="op">&amp;</span></span>
<span>  <span class="va">plots</span><span class="op">$</span><span class="va">POINT_Y</span> <span class="op">&lt;=</span> <span class="va">study_bbox</span><span class="op">[</span><span class="st">"ymax"</span><span class="op">]</span>,</span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Found %d field plots in study region\n"</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">plot_data_raw</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"AGB range: %.1f - %.1f Mg/ha\n"</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">plot_data_raw</span><span class="op">$</span><span class="va">AGB_T_HA</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">plot_data_raw</span><span class="op">$</span><span class="va">AGB_T_HA</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Found 5328 field plots in study region</span></span>
<span><span class="co"># AGB range: 0.0 - 524.8 Mg/ha</span></span>
<span></span>
<span><span class="co"># Assign ecological zones for uncertainty calculations</span></span>
<span><span class="va">plot_data_biome</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/BiomePair.html">BiomePair</a></span><span class="op">(</span><span class="va">plot_data_raw</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Apply temporal adjustment to match map year (2010)</span></span>
<span><span class="co"># This adds AGB_T_HA_ORIG (original) and sdGrowth (temporal variance)</span></span>
<span><span class="va">plot_data_temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/TempApplyVar.html">TempApplyVar</a></span><span class="op">(</span><span class="va">plot_data_biome</span>, map_year <span class="op">=</span> <span class="fl">2010</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate total uncertainty (measurement + sampling + temporal)</span></span>
<span><span class="co"># This adds varPlot, sdTree, sdSE, sdTotal columns</span></span>
<span><span class="va">plot_data_uncertainty</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculateTotalUncertainty.html">calculateTotalUncertainty</a></span><span class="op">(</span></span>
<span>  <span class="va">plot_data_temp</span>,</span>
<span>  map_year <span class="op">=</span> <span class="fl">2010</span>,</span>
<span>  map_resolution <span class="op">=</span> <span class="fl">100</span>  <span class="co"># ESA CCI resolution</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract the data with uncertainty</span></span>
<span><span class="va">plot_data_raw</span> <span class="op">&lt;-</span> <span class="va">plot_data_uncertainty</span><span class="op">$</span><span class="va">data</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"\nAfter preprocessing: %d plots with uncertainty estimates\n"</span>,</span>
<span>            <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">plot_data_raw</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Mean total uncertainty (SD): %.1f Mg/ha\n"</span>,</span>
<span>            <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">plot_data_raw</span><span class="op">$</span><span class="va">sdTotal</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># After preprocessing: 5329 plots with uncertainty estimates</span></span>
<span><span class="co"># Mean total uncertainty (SD): 37.1 Mg/ha</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-1-4-aggregate-plots-using-invdasymetry">Step 1.4 Aggregate Plots Using invDasymetry<a class="anchor" aria-label="anchor" href="#step-1-4-aggregate-plots-using-invdasymetry"></a>
</h2>
<p>We use <code><a href="../reference/invDasymetry.html">invDasymetry()</a></code> to perform inverse dasymetric
mapping. This function:</p>
<ul>
<li>Aggregates plots to 0.1-degree grid cells (~10km at the
equator)</li>
<li>Applies 10% tree cover threshold to filter non-forested areas</li>
<li>Downloads and extracts map AGB from ESA CCI biomass dataset
(2010)</li>
<li>Uses Hansen GFC tree cover data for thresholding</li>
<li>Performs weighted aggregation using plot uncertainty (varPlot)</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Perform inverse dasymetric mapping with aggregation</span></span>
<span><span class="co"># This will download ESA CCI AGB tiles and Hansen GFC tree cover tiles as needed</span></span>
<span><span class="co"># Note: First run may take time due to tile downloads (~600MB per tile)</span></span>
<span><span class="va">AGBdata01</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/invDasymetry.html">invDasymetry</a></span><span class="op">(</span></span>
<span>  plot_data <span class="op">=</span> <span class="va">plot_data_raw</span>,</span>
<span>  clmn <span class="op">=</span> <span class="st">"ZONE"</span>,</span>
<span>  value <span class="op">=</span> <span class="st">"Europe"</span>,        <span class="co"># BiomePair assigns "Europe" for Iberian Peninsula</span></span>
<span>  aggr <span class="op">=</span> <span class="fl">0.1</span>,              <span class="co"># Aggregate to 0.1 degree cells (~10km resolution)</span></span>
<span>  minPlots <span class="op">=</span> <span class="fl">1</span>,            <span class="co"># Minimum 1 plot per aggregated cell</span></span>
<span>  weighted_mean <span class="op">=</span> <span class="cn">TRUE</span>,    <span class="co"># Weight by plot variance (uses varPlot column)</span></span>
<span>  is_poly <span class="op">=</span> <span class="cn">FALSE</span>,         <span class="co"># Point data, not polygons</span></span>
<span>  dataset <span class="op">=</span> <span class="st">"esacci"</span>,      <span class="co"># Use ESA CCI biomass dataset</span></span>
<span>  threshold <span class="op">=</span> <span class="fl">10</span>,          <span class="co"># 10% tree cover threshold</span></span>
<span>  esacci_biomass_year <span class="op">=</span> <span class="fl">2010</span>,  <span class="co"># Use 2010 biomass year</span></span>
<span>  map_resolution <span class="op">=</span> <span class="fl">0.001</span>,  <span class="co"># ESA CCI native resolution in degrees (~100m)</span></span>
<span>  timeout <span class="op">=</span> <span class="fl">600</span>,           <span class="co"># Increase timeout for large tile downloads</span></span>
<span>  parallel <span class="op">=</span> <span class="cn">FALSE</span>         <span class="co"># Set TRUE to use multiple cores</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Aggregated to %d cells\n"</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">AGBdata01</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Plots per cell range: %d - %d\n"</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">AGBdata01</span><span class="op">$</span><span class="va">n</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">AGBdata01</span><span class="op">$</span><span class="va">n</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Aggregated to 2315 cells</span></span>
<span><span class="co"># Plots per cell range: 1 - 11</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">AGBdata01</span><span class="op">)</span></span>
<span><span class="co">#   plotAGB_10 orgPlotAGB mapAGB SIZE_HA   varPlot n     x     y</span></span>
<span><span class="co"># 1    0.00000   34.56482      0   0.196  837.9790 1 -5.65 36.05</span></span>
<span><span class="co"># 2    0.00000   48.53466      0   0.196  927.7217 1 -5.55 36.05</span></span>
<span><span class="co"># 3    0.00000  257.06052      0   0.196  815.7995 2 -5.45 36.05</span></span>
<span><span class="co"># 4    0.00000   41.81695      0   0.196  443.9917 2 -5.95 36.15</span></span>
<span><span class="co"># 5    0.00000   78.25924     36   0.196 1078.2681 1 -5.85 36.15</span></span>
<span><span class="co"># 6   52.78371   42.93809     43   0.196  293.3961 3 -5.65 36.15</span></span></code></pre></div>
<p><strong>Understanding invDasymetry Output:</strong></p>
<ul>
<li>
<strong>plotAGB_10</strong>: Plot AGB after applying 10% tree cover
threshold (weighted mean if multiple plots)</li>
<li>
<strong>PlotAGB</strong>: Tree-filtered plot AGB (before aggregation
weighting)</li>
<li>
<strong>orgPlotAGB</strong>: Original plot AGB (from
AGB_T_HA_ORIG)</li>
<li>
<strong>mapAGB</strong>: Map AGB extracted from ESA CCI for the
aggregated cell</li>
<li>
<strong>SIZE_HA</strong>: Original plot size</li>
<li>
<strong>x, y</strong>: Coordinates (original for single plots,
centroid for aggregated cells)</li>
<li>
<strong>n</strong>: Number of plots in the aggregated cell</li>
</ul>
<p><strong>Note:</strong> First run downloads tiles which takes time,
but subsequent runs reuse cached tiles.</p>
</div>
<div class="section level2">
<h2 id="step-1-5-extract-sd-and-environmental-covariates">Step 1.5 Extract SD and Environmental Covariates<a class="anchor" aria-label="anchor" href="#step-1-5-extract-sd-and-environmental-covariates"></a>
</h2>
<p>Extract SD (uncertainty) and environmental covariates at plot
locations. Note that invDasymetry already extracted map AGB values.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate bias using mapAGB already extracted by invDasymetry</span></span>
<span><span class="va">AGBdata01</span><span class="op">$</span><span class="va">bias</span> <span class="op">&lt;-</span> <span class="va">AGBdata01</span><span class="op">$</span><span class="va">mapAGB</span> <span class="op">-</span> <span class="va">AGBdata01</span><span class="op">$</span><span class="va">plotAGB_10</span></span>
<span></span>
<span><span class="co"># Extract SD at plot locations</span></span>
<span><span class="va">coords_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">AGBdata01</span><span class="op">$</span><span class="va">x</span>, <span class="va">AGBdata01</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="va">sd_values</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">sd_map</span>, <span class="va">coords_matrix</span>, method <span class="op">=</span> <span class="st">"bilinear"</span><span class="op">)</span></span>
<span><span class="co"># Get the SD column (name varies, but it's the non-ID column)</span></span>
<span><span class="va">sd_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sd_values</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sd_values</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"ID"</span><span class="op">]</span></span>
<span><span class="va">AGBdata01</span><span class="op">$</span><span class="va">sd</span> <span class="op">&lt;-</span> <span class="va">sd_values</span><span class="op">[[</span><span class="va">sd_col</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Prepare covariate list (environmental predictors only)</span></span>
<span><span class="va">covariate_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  tcc2010 <span class="op">=</span> <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"tcc2010"</span><span class="op">]</span><span class="op">]</span>,        <span class="co"># GLAD TCC 2010</span></span>
<span>  treecover2000 <span class="op">=</span> <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"treecover2000"</span><span class="op">]</span><span class="op">]</span>, <span class="co"># Hansen GFC Tree Cover</span></span>
<span>  elevation <span class="op">=</span> <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"elevation"</span><span class="op">]</span><span class="op">]</span>,     <span class="co"># SRTM Elevation</span></span>
<span>  slope <span class="op">=</span> <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"slope"</span><span class="op">]</span><span class="op">]</span>,            <span class="co"># SRTM Slope</span></span>
<span>  aspect <span class="op">=</span> <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"aspect"</span><span class="op">]</span><span class="op">]</span>,          <span class="co"># SRTM Aspect</span></span>
<span>  tri <span class="op">=</span> <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"tri"</span><span class="op">]</span><span class="op">]</span>,                <span class="co"># Terrain Ruggedness Index</span></span>
<span>  tpi <span class="op">=</span> <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"tpi"</span><span class="op">]</span><span class="op">]</span>,                <span class="co"># Topographic Position Index</span></span>
<span>  roughness <span class="op">=</span> <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"roughness"</span><span class="op">]</span><span class="op">]</span>,     <span class="co"># SRTM Roughness</span></span>
<span>  biome <span class="op">=</span> <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"biome"</span><span class="op">]</span><span class="op">]</span>,            <span class="co"># RESOLVE Biomes</span></span>
<span>  ifl <span class="op">=</span> <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"ifl"</span><span class="op">]</span><span class="op">]</span>                 <span class="co"># Intact Forest Landscapes</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract environmental covariates using Plot2Map function</span></span>
<span><span class="va">bias_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extractBiasCovariates.html">extractBiasCovariates</a></span><span class="op">(</span></span>
<span>  plot_data <span class="op">=</span> <span class="va">AGBdata01</span>,</span>
<span>  map_agb <span class="op">=</span> <span class="va">agb_map</span>,        <span class="co"># Needed for function but mapAGB already in data</span></span>
<span>  map_sd <span class="op">=</span> <span class="va">sd_map</span>,          <span class="co"># Will extract SD at plot locations</span></span>
<span>  covariates <span class="op">=</span> <span class="va">covariate_list</span>,</span>
<span>  plot_agb_col <span class="op">=</span> <span class="st">"plotAGB_10"</span>,</span>
<span>  map_agb_col <span class="op">=</span> <span class="st">"mapAGB"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The function:</span></span>
<span><span class="co"># - Re-extracts map AGB for consistency (may differ slightly from invDasymetry's mapAGB)</span></span>
<span><span class="co"># - Extracts SD at plot locations</span></span>
<span><span class="co"># - Extracts all environmental covariates</span></span>
<span><span class="co"># - Calculates bias = map - plot</span></span>
<span><span class="co"># - Handles IFL NAs (converts to 0/1)</span></span>
<span></span>
<span><span class="co"># View summary</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Extracted covariates for %d plots\n"</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">bias_data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Bias range: %.1f to %.1f Mg/ha (mean: %.1f)\n"</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">bias_data</span><span class="op">$</span><span class="va">bias</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">bias_data</span><span class="op">$</span><span class="va">bias</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">bias_data</span><span class="op">$</span><span class="va">bias</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Extracted covariates for 2252 plots</span></span>
<span><span class="co"># Bias range: -226.5 to 140.5 Mg/ha (mean: -4.7)            </span></span>
<span></span>
<span><span class="co"># Remove rows with NA in key predictors</span></span>
<span><span class="va">bias_data</span> <span class="op">&lt;-</span> <span class="va">bias_data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html" class="external-link">complete.cases</a></span><span class="op">(</span><span class="va">bias_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bias"</span>, <span class="st">"map"</span>, <span class="st">"sd"</span>, <span class="st">"tcc2010"</span>,</span>
<span>                                                      <span class="st">"treecover2000"</span>, <span class="st">"elevation"</span>,</span>
<span>                                                      <span class="st">"slope"</span>, <span class="st">"biome"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># View first few rows</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">bias_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"plotAGB_10"</span>, <span class="st">"map"</span>, <span class="st">"bias"</span>, <span class="st">"sd"</span>, <span class="st">"n"</span>,</span>
<span>                   <span class="st">"tcc2010"</span>, <span class="st">"treecover2000"</span>, <span class="st">"elevation"</span>, <span class="st">"slope"</span>, <span class="st">"biome"</span>, <span class="st">"ifl"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#    plotAGB_10      map       bias       sd n   tcc2010 treecover2000</span></span>
<span><span class="co"># 34   41.53545 43.88520   2.349748 47.24985 1 20.556629     24.931438</span></span>
<span><span class="co"># 35    0.00000 19.39892  19.398923 21.64299 1  4.024915      5.793305</span></span>
<span><span class="co"># 45   84.27828 60.53891 -23.739374 57.69286 3 36.546947     43.156471</span></span>
<span><span class="co"># 46    0.00000 29.60302  29.603018 32.86933 2 20.944866     28.317051</span></span>
<span><span class="co"># 47    0.00000 22.07312  22.073122 23.85247 4 11.896482     17.335209</span></span>
<span><span class="co"># 48    0.00000 21.84692  21.846915 22.83851 2 13.742061     18.933186</span></span>
<span><span class="co">#    elevation     slope biome ifl</span></span>
<span><span class="co"># 34  450.5413 16.082890    12   1</span></span>
<span><span class="co"># 35  104.3886  5.462058    12   1</span></span>
<span><span class="co"># 45  799.8615 20.046154    12   1</span></span>
<span><span class="co"># 46  450.6864 13.713544    12   1</span></span>
<span><span class="co"># 47  264.5391  8.814684    12   1</span></span>
<span><span class="co"># 48  275.6924  9.817000    12   1</span></span></code></pre></div>
<p><strong>Note on Map AGB Values:</strong></p>
<ul>
<li>
<code><a href="../reference/invDasymetry.html">invDasymetry()</a></code> extracts map AGB at aggregated cell
locations → <code>mapAGB</code> column</li>
<li>
<code><a href="../reference/extractBiasCovariates.html">extractBiasCovariates()</a></code> re-extracts map AGB for
consistency with other covariates → <code>map</code> column</li>
<li>Values may differ slightly due to aggregation vs point
extraction</li>
<li>For bias modeling, use the <code>map</code> column (from
extractBiasCovariates) as predictor</li>
</ul>
<p><strong>Understanding the Extracted Data:</strong></p>
<ul>
<li>
<strong>bias</strong>: Map AGB - Plot AGB (Mg/ha). Positive =
overestimate, negative = underestimate</li>
<li>
<strong>mapAGB</strong>: ESA CCI biomass value from
invDasymetry</li>
<li>
<strong>plotAGB_10</strong>: Field plot AGB after 10% tree cover
threshold</li>
<li>
<strong>Covariates</strong>: Environmental predictors from
spatialcovariates:
<ul>
<li>
<code>tcc2010</code>: GLAD Tree Canopy Cover 2010 (%)</li>
<li>
<code>treecover2000</code>: Hansen GFC Tree Cover 2000 (%)</li>
<li>
<code>elevation</code>: SRTM elevation (m)</li>
<li>
<code>slope</code>: SRTM slope (degrees)</li>
<li>
<code>aspect</code>: SRTM aspect (degrees)</li>
<li>
<code>tri</code>: Terrain Ruggedness Index</li>
<li>
<code>tpi</code>: Topographic Position Index</li>
<li>
<code>roughness</code>: SRTM roughness</li>
<li>
<code>biome</code>: RESOLVE Ecoregion ID (1-14)</li>
<li>
<code>ifl</code>: Intact Forest Landscape binary (0/1)</li>
</ul>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="step-2--train-bias-model">Step 2. Train Bias Model<a class="anchor" aria-label="anchor" href="#step-2--train-bias-model"></a>
</h2>
<p>Use Plot2Map’s <code><a href="../reference/trainBiasModel.html">trainBiasModel()</a></code> function to train a
Random Forest model predicting bias from environmental covariates.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define predictors to use in the model</span></span>
<span><span class="co"># Note: extractBiasCovariates() creates a "map" column (not "mapAGB")</span></span>
<span><span class="va">available_predictors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"map"</span>,            <span class="co"># Map AGB value from extractBiasCovariates (strongest predictor)</span></span>
<span>  <span class="st">"sd"</span>,             <span class="co"># Map SD (uncertainty) from extractBiasCovariates</span></span>
<span>  <span class="st">"tcc2010"</span>,        <span class="co"># GLAD Tree Cover 2010</span></span>
<span>  <span class="st">"treecover2000"</span>,  <span class="co"># Hansen GFC Tree Cover 2000</span></span>
<span>  <span class="st">"elevation"</span>,      <span class="co"># SRTM Elevation</span></span>
<span>  <span class="st">"slope"</span>,          <span class="co"># SRTM Slope</span></span>
<span>  <span class="st">"tri"</span>,            <span class="co"># Terrain Ruggedness Index</span></span>
<span>  <span class="st">"biome"</span>,          <span class="co"># RESOLVE Ecoregion ID</span></span>
<span>  <span class="st">"ifl"</span>             <span class="co"># Intact Forest Landscapes</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Train bias model using Plot2Map's trainBiasModel() function</span></span>
<span><span class="co"># This uses ranger by default (faster than randomForest)</span></span>
<span><span class="va">bias_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trainBiasModel.html">trainBiasModel</a></span><span class="op">(</span></span>
<span>  bias_data <span class="op">=</span> <span class="va">bias_data</span>,</span>
<span>  predictors <span class="op">=</span> <span class="va">available_predictors</span>,</span>
<span>  response <span class="op">=</span> <span class="st">"bias"</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"ranger"</span>,      <span class="co"># Fast Random Forest implementation</span></span>
<span>  seed <span class="op">=</span> <span class="fl">1234</span>,</span>
<span>  cv_folds <span class="op">=</span> <span class="fl">10</span>,          <span class="co"># 10-fold cross-validation for performance assessment</span></span>
<span>  importance <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The function automatically:</span></span>
<span><span class="co"># - Removes rows with NA values</span></span>
<span><span class="co"># - Trains the Random Forest model</span></span>
<span><span class="co"># - Calculates variable importance</span></span>
<span><span class="co"># - Performs cross-validation (if cv_folds specified)</span></span>
<span><span class="co"># - Provides summary statistics</span></span>
<span></span>
<span><span class="co"># View model summary</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">bias_model</span><span class="op">$</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View variable importance (sorted by importance)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">bias_model</span><span class="op">$</span><span class="va">importance</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View cross-validation results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">bias_model</span><span class="op">$</span><span class="va">cv_results</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Ranger result</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Call:</span></span>
<span><span class="co">#  ranger::ranger(formula = model_formula, data = model_data_complete,      importance = if (importance) "impurity" else "none", ...) </span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Type:                             Regression </span></span>
<span><span class="co"># Number of trees:                  500 </span></span>
<span><span class="co"># Sample size:                      2252 </span></span>
<span><span class="co"># Number of independent variables:  9 </span></span>
<span><span class="co"># Mtry:                             3 </span></span>
<span><span class="co"># Target node size:                 5 </span></span>
<span><span class="co"># Variable importance mode:         impurity </span></span>
<span><span class="co"># Splitrule:                        variance </span></span>
<span><span class="co"># OOB prediction error (MSE):       1217.191 </span></span>
<span><span class="co"># R squared (OOB):                  0.02720926 </span></span>
<span><span class="co">#        variable importance</span></span>
<span><span class="co"># 1            sd   404705.5</span></span>
<span><span class="co"># 2           map   392795.2</span></span>
<span><span class="co"># 3 treecover2000   351430.9</span></span>
<span><span class="co"># 4       tcc2010   348972.4</span></span>
<span><span class="co"># 5     elevation   348516.3</span></span>
<span><span class="co"># 6           tri   299525.7</span></span>
<span><span class="co"># 7         slope   297919.3</span></span>
<span><span class="co"># 8         biome   136069.5</span></span>
<span><span class="co"># 9           ifl        0.0</span></span>
<span><span class="co">#    fold     rmse      mae          r2</span></span>
<span><span class="co"># 1     1 30.15413 22.12308  0.04694548</span></span>
<span><span class="co"># 2     2 35.59177 26.17018 -0.04708248</span></span>
<span><span class="co"># 3     3 33.97550 24.92628  0.03148145</span></span>
<span><span class="co"># 4     4 39.41655 27.64070 -0.10580273</span></span>
<span><span class="co"># 5     5 35.57132 26.66941  0.04765322</span></span>
<span><span class="co"># 6     6 37.22815 26.83647  0.03066245</span></span>
<span><span class="co"># 7     7 32.60076 23.00654  0.13647454</span></span>
<span><span class="co"># 8     8 34.76477 24.94573  0.02377993</span></span>
<span><span class="co"># 9     9 36.02965 25.16412  0.03407574</span></span>
<span><span class="co"># 10   10 32.71760 24.40701  0.04779314</span></span>
<span><span class="co"># 11    0 34.80502 25.18895  0.02459807</span></span></code></pre></div>
<p><strong>Model Performance Metrics:</strong></p>
<ul>
<li>
<strong>RMSE</strong>: Root Mean Square Error (Mg/ha) - measures
average prediction error</li>
<li>
<strong>MAE</strong>: Mean Absolute Error (Mg/ha) - easier to
interpret than RMSE</li>
<li>
<strong>R²</strong>: Proportion of variance explained (0-1) - model
fit quality</li>
</ul>
<p>The R² of the above model of 0.027 is low but this is expected for
temperate forests with lower biomass and less systematic bias. The RMSE:
~35 Mg/ha is also acceptable for temperate forests and the CV RMSE
stability across 10 folds is consistent.</p>
<p><strong>Using randomForest Instead:</strong></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Alternative: use randomForest package </span></span>
<span><span class="va">bias_model_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trainBiasModel.html">trainBiasModel</a></span><span class="op">(</span></span>
<span>  bias_data <span class="op">=</span> <span class="va">bias_data</span>,</span>
<span>  predictors <span class="op">=</span> <span class="va">available_predictors</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"randomForest"</span>,</span>
<span>  cv_folds <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  importance <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  ntree <span class="op">=</span> <span class="fl">500</span>  <span class="co"># Pass additional randomForest parameters via ...</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-3--generate-wall-to-wall-bias-map">Step 3. Generate Wall-to-Wall Bias Map<a class="anchor" aria-label="anchor" href="#step-3--generate-wall-to-wall-bias-map"></a>
</h2>
<p>Use Plot2Map’s <code><a href="../reference/predictBiasMap.html">predictBiasMap()</a></code> function to predict bias
across the entire study region.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare covariate stack with names matching model predictors</span></span>
<span><span class="co"># Note: extractBiasCovariates() uses "map" and "sd" column names</span></span>
<span></span>
<span><span class="co"># First, ensure all rasters have the same extent/resolution by resampling to covariates_stack</span></span>
<span><span class="va">agb_map_aligned</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/resample.html" class="external-link">resample</a></span><span class="op">(</span><span class="va">agb_map</span>, <span class="va">covariates_stack</span>, method <span class="op">=</span> <span class="st">"bilinear"</span><span class="op">)</span></span>
<span><span class="va">sd_map_aligned</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/resample.html" class="external-link">resample</a></span><span class="op">(</span><span class="va">sd_map</span>, <span class="va">covariates_stack</span>, method <span class="op">=</span> <span class="st">"bilinear"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now stack them together</span></span>
<span><span class="va">covs_for_prediction</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="va">agb_map_aligned</span>,                      <span class="co"># ESA CCI AGB (aligned)</span></span>
<span>  <span class="va">sd_map_aligned</span>,                       <span class="co"># ESA CCI SD (aligned)</span></span>
<span>  <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"tcc2010"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"treecover2000"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"elevation"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"slope"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"tri"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"biome"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"ifl"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Name layers to match model predictors EXACTLY</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">covs_for_prediction</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"map"</span>, <span class="st">"sd"</span>, <span class="st">"tcc2010"</span>, <span class="st">"treecover2000"</span>,</span>
<span>                                 <span class="st">"elevation"</span>, <span class="st">"slope"</span>, <span class="st">"tri"</span>, <span class="st">"biome"</span>, <span class="st">"ifl"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Handle missing values in IFL layer</span></span>
<span><span class="va">covs_for_prediction</span><span class="op">$</span><span class="va">ifl</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">covs_for_prediction</span><span class="op">$</span><span class="va">ifl</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="co"># Predict bias wall-to-wall using Plot2Map's predictBiasMap()</span></span>
<span><span class="va">bias_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predictBiasMap.html">predictBiasMap</a></span><span class="op">(</span></span>
<span>  bias_model <span class="op">=</span> <span class="va">bias_model</span>,</span>
<span>  covariate_stack <span class="op">=</span> <span class="va">covs_for_prediction</span>,</span>
<span>  filename <span class="op">=</span> <span class="cn">NULL</span>,  <span class="co"># Set to path for large regions (e.g., "output/bias_map_10km.tif")</span></span>
<span>  return_raster <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The function automatically:</span></span>
<span><span class="co"># - Validates that all predictors are present</span></span>
<span><span class="co"># - Applies the trained model to all pixels</span></span>
<span><span class="co"># - Provides summary statistics</span></span>
<span><span class="co"># - Optionally writes to disk for memory efficiency</span></span>
<span></span>
<span><span class="co"># Visualize bias map</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bias_map</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Predicted Bias Map (Mg/ha)\n(Positive = Map Overestimates)"</span>,</span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Add plot locations for reference</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">bias_data</span><span class="op">$</span><span class="va">x</span>, <span class="va">bias_data</span><span class="op">$</span><span class="va">y</span>, pch <span class="op">=</span> <span class="fl">20</span>, cex <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="bias_map_iberia.png" alt="Predicted Bias Map for Iberian Peninsula"><div class="figcaption">Predicted Bias Map for Iberian Peninsula</div>
</div>
<p><strong>Memory Management Tip:</strong></p>
<p>For large regions, write the prediction directly to disk:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Write bias map directly to file for memory-efficient processing</span></span>
<span><span class="va">bias_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predictBiasMap.html">predictBiasMap</a></span><span class="op">(</span></span>
<span>  bias_model <span class="op">=</span> <span class="va">bias_model</span>,</span>
<span>  covariate_stack <span class="op">=</span> <span class="va">covs_for_prediction</span>,</span>
<span>  filename <span class="op">=</span> <span class="st">"output/bias_map_10km.tif"</span>,</span>
<span>  return_raster <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span>  <span class="co"># Pass additional terra::writeRaster arguments</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Interpreting the Bias Map</strong></p>
<ul>
<li>
<strong>Positive values (red)</strong>: Map overestimates AGB in
these areas</li>
<li>
<strong>Negative values (blue)</strong>: Map underestimates AGB in
these areas</li>
<li>
<strong>Near zero (white)</strong>: Map is relatively unbiased</li>
</ul>
<p>Look for spatial patterns - do errors cluster by forest type,
elevation, or climate?</p>
</div>
<div class="section level2">
<h2 id="step-4--adjust-agb-map">Step 4. Adjust AGB Map<a class="anchor" aria-label="anchor" href="#step-4--adjust-agb-map"></a>
</h2>
<p>Use Plot2Map’s <code><a href="../reference/adjustMapBias.html">adjustMapBias()</a></code> function to apply the
bias correction and calculate regional totals.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Adjust AGB map using Plot2Map's adjustMapBias() function</span></span>
<span><span class="co"># Note: Use agb_map_aligned (from Step 4) to ensure matching extents</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/adjustMapBias.html">adjustMapBias</a></span><span class="op">(</span></span>
<span>  map_agb <span class="op">=</span> <span class="va">agb_map_aligned</span>,  <span class="co"># Use aligned version from Step 4</span></span>
<span>  bias_map <span class="op">=</span> <span class="va">bias_map</span>,</span>
<span>  forest_mask <span class="op">=</span> <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"tcc2010"</span><span class="op">]</span><span class="op">]</span>,  <span class="co"># Use tree cover for masking</span></span>
<span>  threshold <span class="op">=</span> <span class="fl">10</span>,          <span class="co"># 10% tree cover threshold for forest definition</span></span>
<span>  scale_factor <span class="op">=</span> <span class="cn">NULL</span>,     <span class="co"># Auto-calculate from raster resolution</span></span>
<span>  return_totals <span class="op">=</span> <span class="cn">TRUE</span>     <span class="co"># Calculate regional totals with comparison</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The function automatically:</span></span>
<span><span class="co"># - Subtracts predicted bias from original map</span></span>
<span><span class="co"># - Applies forest mask with threshold</span></span>
<span><span class="co"># - Calculates regional totals for both maps</span></span>
<span><span class="co"># - Computes percentage change</span></span>
<span><span class="co"># - Provides formatted summary output</span></span>
<span></span>
<span><span class="co"># Access results</span></span>
<span><span class="va">map_adjusted</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">adjusted_map</span>        <span class="co"># Bias-corrected AGB map</span></span>
<span><span class="va">default_total</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">default_total</span>      <span class="co"># Original map total (Mg)</span></span>
<span><span class="va">adjusted_total</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">adjusted_total</span>    <span class="co"># Adjusted map total (Mg)</span></span>
<span><span class="va">percent_change</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">percent_change</span>    <span class="co"># % change from original</span></span>
<span><span class="va">n_cells</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">n_cells</span>                  <span class="co"># Number of forest cells</span></span>
<span></span>
<span><span class="co"># Example output:</span></span>
<span><span class="co"># Adjusting AGB map by subtracting predicted bias...</span></span>
<span><span class="co"># Mean bias correction: 5.88 Mg/ha</span></span>
<span><span class="co"># Calculating regional totals...</span></span>
<span><span class="co"># Applying forest mask with threshold = 10%</span></span>
<span><span class="co"># Auto-calculated scale factor: 8539.15 (based on 9.24 x 9.24 km pixels)</span></span>
<span></span>
<span><span class="co"># === Regional AGB Totals ===</span></span>
<span><span class="co"># Default map:  17,337,802,140 Mg</span></span>
<span><span class="co"># Adjusted map: 16,989,503,442 Mg</span></span>
<span><span class="co"># Difference:   -348,298,699 Mg (-2.0%)</span></span>
<span><span class="co"># Based on 6,901 forest cells</span></span>
<span></span>
<span><span class="co"># Plot comparison</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">RColorBrewer</span><span class="op">)</span></span>
<span><span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span><span class="fl">9</span>, <span class="st">"YlGn"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cuts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">25</span>, <span class="fl">50</span>, <span class="fl">75</span>, <span class="fl">100</span>, <span class="fl">150</span>, <span class="fl">200</span>, <span class="fl">250</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Apply mask for visualization (use aligned version)</span></span>
<span><span class="va">map_default_masked</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">agb_map_aligned</span>, <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"tcc2010"</span><span class="op">]</span><span class="op">]</span> <span class="op">&gt;=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">map_adjusted_masked</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">map_adjusted</span>, <span class="va">covariates_stack</span><span class="op">[[</span><span class="st">"tcc2010"</span><span class="op">]</span><span class="op">]</span> <span class="op">&gt;=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">map_default_masked</span>, breaks <span class="op">=</span> <span class="va">cuts</span>, col <span class="op">=</span> <span class="fu">pal</span><span class="op">(</span><span class="fl">9</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"Original AGB Map"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">map_adjusted_masked</span>, breaks <span class="op">=</span> <span class="va">cuts</span>, col <span class="op">=</span> <span class="fu">pal</span><span class="op">(</span><span class="fl">9</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"Bias-Adjusted AGB"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save bias-corrected map</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">map_adjusted</span>, filename <span class="op">=</span> <span class="st">"agb_bias_corrected_10km.tif"</span>,</span>
<span>                   overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="bias_adjusted_agb.png" alt="Bias-Adjusted Map for Iberian Peninsula"><div class="figcaption">Bias-Adjusted Map for Iberian Peninsula</div>
</div>
<p><strong>Understanding the Adjustment:</strong></p>
<p>The bias correction follows:
<code>AGB_adjusted = AGB_original - bias_predicted</code></p>
<ul>
<li>Positive bias (overestimation) → AGB is reduced</li>
<li>Negative bias (underestimation) → AGB is increased</li>
</ul>
<p><strong>Regional Totals:</strong></p>
<p>The function automatically calculates regional totals accounting
for:</p>
<ul>
<li>Forest mask (10% tree cover threshold)</li>
<li>Pixel area (auto-calculated from resolution)</li>
<li>Valid (non-NA) pixels only</li>
<li>
<strong>default_total</strong>: Total biomass in original map
(Mg)</li>
<li>
<strong>adjusted_total</strong>: Total biomass in corrected map
(Mg)</li>
<li>
<strong>percent_change</strong>: Percent change due to
correction</li>
<li>
<strong>n_pixels</strong>: Number of pixels included in totals</li>
</ul>
</div>
<div class="section level2">
<h2 id="choosing-covariates">Choosing Covariates<a class="anchor" aria-label="anchor" href="#choosing-covariates"></a>
</h2>
<p>Possible bias predictors include:</p>
<div class="section level3">
<h3 id="topographic-variables">Topographic Variables<a class="anchor" aria-label="anchor" href="#topographic-variables"></a>
</h3>
<ul>
<li>
<strong>Elevation</strong>: Affects vegetation type and sensor
performance</li>
<li>
<strong>Slope</strong>: Influences radar/optical signal quality</li>
<li>
<strong>Aspect</strong>: Related to solar radiation and
moisture</li>
</ul>
</div>
<div class="section level3">
<h3 id="climate-variables">Climate Variables<a class="anchor" aria-label="anchor" href="#climate-variables"></a>
</h3>
<ul>
<li>
<strong>Precipitation</strong>: Drives forest productivity and
structure</li>
<li>
<strong>Temperature</strong>: Influences species composition and
growth</li>
<li>
<strong>Seasonality</strong>: Affects phenology and sensor
observations</li>
</ul>
</div>
<div class="section level3">
<h3 id="vegetation-indices">Vegetation Indices<a class="anchor" aria-label="anchor" href="#vegetation-indices"></a>
</h3>
<ul>
<li>
<strong>NDVI</strong>: Greenness and photosynthetic activity</li>
<li>
<strong>EVI</strong>: Enhanced vegetation index (less
saturated)</li>
<li>
<strong>SAVI</strong>: Soil-adjusted vegetation index</li>
</ul>
</div>
<div class="section level3">
<h3 id="forest-structure">Forest Structure<a class="anchor" aria-label="anchor" href="#forest-structure"></a>
</h3>
<ul>
<li>
<strong>Tree cover percentage</strong>: Forest density</li>
<li>
<strong>Forest height</strong>: Canopy height from lidar/radar</li>
<li>
<strong>Forest type</strong>: Categorical forest classes</li>
</ul>
</div>
<div class="section level3">
<h3 id="tips-for-covariate-selection">Tips for Covariate Selection<a class="anchor" aria-label="anchor" href="#tips-for-covariate-selection"></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<strong>Start simple</strong>: Use 3-5 key variables first</li>
<li>
<strong>Check correlations</strong>: Avoid highly correlated
covariates (r &gt; 0.8)</li>
<li>
<strong>Examine importance</strong>: Remove variables with very low
importance</li>
<li>
<strong>Consider mechanisms</strong>: Choose variables related to
sensor/vegetation physics</li>
<li>
<strong>Match map resolution</strong>: Covariates should have
similar or finer resolution than AGB map</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="model-diagnostics">Model Diagnostics<a class="anchor" aria-label="anchor" href="#model-diagnostics"></a>
</h2>
<div class="section level3">
<h3 id="evaluating-model-performance">Evaluating Model Performance<a class="anchor" aria-label="anchor" href="#evaluating-model-performance"></a>
</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Cross-validation performance (from trainBiasModel output)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">bias_model</span><span class="op">$</span><span class="va">cv_results</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cv_results</span> <span class="op">&lt;-</span> <span class="va">bias_model</span><span class="op">$</span><span class="va">cv_results</span></span>
<span>  <span class="co"># Note: Column names are lowercase (rmse, mae, r2)</span></span>
<span>  <span class="co"># Last row (fold = 0) contains overall mean</span></span>
<span>  <span class="va">overall</span> <span class="op">&lt;-</span> <span class="va">cv_results</span><span class="op">[</span><span class="va">cv_results</span><span class="op">$</span><span class="va">fold</span> <span class="op">==</span> <span class="fl">0</span>, <span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Mean RMSE:"</span>, <span class="va">overall</span><span class="op">$</span><span class="va">rmse</span>, <span class="st">"Mg/ha\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Mean R²:"</span>, <span class="va">overall</span><span class="op">$</span><span class="va">r2</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Mean MAE:"</span>, <span class="va">overall</span><span class="op">$</span><span class="va">mae</span>, <span class="st">"Mg/ha\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Variable importance (already sorted by trainBiasModel)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">bias_model</span><span class="op">$</span><span class="va">importance</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">bias_model</span><span class="op">$</span><span class="va">importance</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Model summary</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">bias_model</span><span class="op">$</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mean RMSE: 34.47492 Mg/ha</span></span>
<span><span class="co"># Mean R²: 0.02573251 </span></span>
<span><span class="co"># Mean MAE: 25.02232 Mg/ha</span></span>
<span><span class="co">#        variable importance</span></span>
<span><span class="co"># 1            sd   412588.8</span></span>
<span><span class="co"># 2           map   395859.3</span></span>
<span><span class="co"># 3 treecover2000   350578.9</span></span>
<span><span class="co"># 4       tcc2010   348482.5</span></span>
<span><span class="co"># 5     elevation   345569.8</span></span>
<span><span class="co"># 6           tri   312663.6</span></span>
<span><span class="co"># 7         slope   301559.8</span></span>
<span><span class="co"># 8         biome   143290.9</span></span>
<span><span class="co"># 9           ifl        0.0</span></span>
<span><span class="co"># Ranger result</span></span>
<span></span>
<span><span class="co"># Call:</span></span>
<span><span class="co">#  ranger::ranger(formula = model_formula, data = model_data_complete,      importance = if (importance) "impurity" else "none", ...) </span></span>
<span></span>
<span><span class="co"># Type:                             Regression </span></span>
<span><span class="co"># Number of trees:                  500 </span></span>
<span><span class="co"># Sample size:                      2313 </span></span>
<span><span class="co"># Number of independent variables:  9 </span></span>
<span><span class="co"># Mtry:                             3 </span></span>
<span><span class="co"># Target node size:                 5 </span></span>
<span><span class="co"># Variable importance mode:         impurity </span></span>
<span><span class="co"># Splitrule:                        variance </span></span>
<span><span class="co"># OOB prediction error (MSE):       1205.136 </span></span>
<span><span class="co"># R squared (OOB):                  0.02434644 </span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="best-practices">Best Practices<a class="anchor" aria-label="anchor" href="#best-practices"></a>
</h2>
<div class="section level3">
<h3 id="data-quality">1. Data Quality<a class="anchor" aria-label="anchor" href="#data-quality"></a>
</h3>
<ul>
<li>
<strong>Plot data</strong>: Ensure accurate coordinates and AGB
estimates</li>
<li>
<strong>Temporal matching</strong>: Plots should be contemporary
with map epoch</li>
<li>
<strong>Spatial matching</strong>: Use appropriate buffer size for
plot heterogeneity</li>
</ul>
</div>
<div class="section level3">
<h3 id="model-training">2. Model Training<a class="anchor" aria-label="anchor" href="#model-training"></a>
</h3>
<ul>
<li>
<strong>Sample size</strong>: Minimum 50-100 plots for stable
models, ideally 200+</li>
<li>
<strong>Cross-validation</strong>: Always use CV to assess
generalization</li>
<li>
<strong>Hyperparameters</strong>: Default values usually work well,
but test alternatives</li>
</ul>
</div>
<div class="section level3">
<h3 id="covariate-preparation">3. Covariate Preparation<a class="anchor" aria-label="anchor" href="#covariate-preparation"></a>
</h3>
<ul>
<li>
<strong>Resolution</strong>: Match covariate resolution to AGB
map</li>
<li>
<strong>Missing data</strong>: Handle NA values before modeling</li>
<li>
<strong>Scaling</strong>: Random Forests don’t require scaling, but
check for extreme values</li>
</ul>
</div>
<div class="section level3">
<h3 id="interpretation">4. Interpretation<a class="anchor" aria-label="anchor" href="#interpretation"></a>
</h3>
<ul>
<li>
<strong>Spatial patterns</strong>: Examine bias map for
interpretable patterns</li>
<li>
<strong>Regional totals</strong>: Check if adjustment direction
makes sense</li>
<li>
<strong>Validation</strong>: If possible, validate adjusted map with
independent data</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="common-issues-and-solutions">Common Issues and Solutions<a class="anchor" aria-label="anchor" href="#common-issues-and-solutions"></a>
</h2>
<div class="section level3">
<h3 id="issue-high-rmse-despite-good-r²">Issue: High RMSE Despite Good R²<a class="anchor" aria-label="anchor" href="#issue-high-rmse-despite-good-r%C2%B2"></a>
</h3>
<p><strong>Cause</strong>: Large variance in bias values
<strong>Solution</strong>: - Check for outliers in plot data - Consider
stratifying by forest type - Add more relevant covariates</p>
</div>
<div class="section level3">
<h3 id="issue-low-variable-importance-for-all-predictors">Issue: Low Variable Importance for All Predictors<a class="anchor" aria-label="anchor" href="#issue-low-variable-importance-for-all-predictors"></a>
</h3>
<p><strong>Cause</strong>: Covariates don’t explain bias patterns
<strong>Solution</strong>: - Try different covariates related to map
creation method - Check if bias is spatially random (no systematic
patterns) - Increase sample size</p>
</div>
<div class="section level3">
<h3 id="issue-adjusted-map-has-negative-values">Issue: Adjusted Map Has Negative Values<a class="anchor" aria-label="anchor" href="#issue-adjusted-map-has-negative-values"></a>
</h3>
<p><strong>Cause</strong>: Bias prediction too large
<strong>Solution</strong>: The <code><a href="../reference/adjustMapBias.html">adjustMapBias()</a></code> function
automatically sets negatives to zero, but check: - Extreme bias
predictions (outliers) - Whether model is overpredicting in low-biomass
areas</p>
</div>
<div class="section level3">
<h3 id="issue-memory-errors-with-large-rasters">Issue: Memory Errors with Large Rasters<a class="anchor" aria-label="anchor" href="#issue-memory-errors-with-large-rasters"></a>
</h3>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Write directly to disk for memory-efficient processing</span></span>
<span><span class="va">bias_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predictBiasMap.html">predictBiasMap</a></span><span class="op">(</span></span>
<span>  bias_model <span class="op">=</span> <span class="va">bias_model</span>,</span>
<span>  covariate_stack <span class="op">=</span> <span class="va">covs_for_prediction</span>,  <span class="co"># From Step 4</span></span>
<span>  filename <span class="op">=</span> <span class="st">"bias_map.tif"</span>,  <span class="co"># Required for large rasters</span></span>
<span>  return_raster <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="next-steps">Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<p>After bias correction, you may want to:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Quantify uncertainty</strong>: Use the advanced uncertainty
quantification workflow (see
<code><a href="../articles/advanced-uncertainty.html">vignette("advanced-uncertainty")</a></code>)</li>
<li>
<strong>Validate results</strong>: Compare adjusted map with
independent validation plots</li>
<li>
<strong>Stratified analysis</strong>: Repeat bias modeling by forest
type or region</li>
<li>
<strong>Temporal analysis</strong>: Apply to multiple map epochs to
track changes</li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/arnanaraza" class="external-link">Arnan Araza</a>, <a href="https://github.com/aTnT" class="external-link">André Tavares</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
