<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Fit Variogram to Residuals After Bias Modeling — fitResidualVariogram • Plot2Map</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.10/font.css" rel="stylesheet"><link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fit Variogram to Residuals After Bias Modeling — fitResidualVariogram"><meta name="description" content="Fits a variogram model to the scaled residuals from bias modeling to characterize
spatial autocorrelation in the remaining prediction errors. This is a critical step
for uncertainty quantification as it allows proper aggregation of standard errors
accounting for spatial correlation."><meta property="og:description" content="Fits a variogram model to the scaled residuals from bias modeling to characterize
spatial autocorrelation in the remaining prediction errors. This is a critical step
for uncertainty quantification as it allows proper aggregation of standard errors
accounting for spatial correlation."><meta property="og:image" content="https://atnt.github.io/Plot2Map/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Plot2Map</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/introduction.html">Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/plot-data-preparation.html">Plot data preparation</a></li>
    <li><a class="dropdown-item" href="../articles/bias-modeling.html">Bias Modeling and Correction for AGB Maps</a></li>
    <li><a class="dropdown-item" href="../articles/advanced-uncertainty.html">Advanced Uncertainty Quantification with Spatial Correlation</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch"><li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Fit Variogram to Residuals After Bias Modeling</h1>

      <div class="d-none name"><code>fitResidualVariogram.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Fits a variogram model to the scaled residuals from bias modeling to characterize
spatial autocorrelation in the remaining prediction errors. This is a critical step
for uncertainty quantification as it allows proper aggregation of standard errors
accounting for spatial correlation.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">fitResidualVariogram</span><span class="op">(</span></span>
<span>  <span class="va">bias_data</span>,</span>
<span>  <span class="va">map_sd_raster</span>,</span>
<span>  model <span class="op">=</span> <span class="st">"Sph"</span>,</span>
<span>  cutoff <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  width <span class="op">=</span> <span class="va">cutoff</span><span class="op">/</span><span class="fl">15</span>,</span>
<span>  psill <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  range <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  nugget <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  coord_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span>,</span>
<span>  crs <span class="op">=</span> <span class="st">"EPSG:4326"</span>,</span>
<span>  remove_outliers <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  plot <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-bias-data">bias_data<a class="anchor" aria-label="anchor" href="#arg-bias-data"></a></dt>
<dd><p>A data.frame with plot locations and bias modeling results.
Must contain columns: <code>bias</code> (observed bias), <code>biasPred</code> (predicted bias
from <code><a href="trainBiasModel.html">trainBiasModel()</a></code>), coordinates (lon/lat or x/y), and will be joined
with SD values from <code>map_sd_raster</code>.</p></dd>


<dt id="arg-map-sd-raster">map_sd_raster<a class="anchor" aria-label="anchor" href="#arg-map-sd-raster"></a></dt>
<dd><p>SpatRaster containing pixel-level standard deviation of AGB
(Mg/ha). Used to scale residuals: resid = (bias - biasPred) / sd.</p></dd>


<dt id="arg-model">model<a class="anchor" aria-label="anchor" href="#arg-model"></a></dt>
<dd><p>Character. Variogram model type to fit. Options: "Sph" (Spherical,
default), "Exp" (Exponential), "Gau" (Gaussian), "Mat" (Matern). See
<code><a href="https://r-spatial.github.io/gstat/reference/vgm.html" class="external-link">gstat::vgm()</a></code> for details.</p></dd>


<dt id="arg-cutoff">cutoff<a class="anchor" aria-label="anchor" href="#arg-cutoff"></a></dt>
<dd><p>Numeric. Maximum distance in kilometers for variogram calculation.
Default: 50. Should be roughly half the maximum distance between plots.
The function automatically converts to meters after UTM transformation.</p></dd>


<dt id="arg-width">width<a class="anchor" aria-label="anchor" href="#arg-width"></a></dt>
<dd><p>Numeric. Width of distance bins in kilometers for empirical variogram.
Default: <code>cutoff/15</code>. Smaller values give more detail but more noise.</p></dd>


<dt id="arg-psill">psill<a class="anchor" aria-label="anchor" href="#arg-psill"></a></dt>
<dd><p>Numeric. Initial partial sill for variogram fitting. Default: 3.
Adjust based on variance of scaled residuals.</p></dd>


<dt id="arg-range">range<a class="anchor" aria-label="anchor" href="#arg-range"></a></dt>
<dd><p>Numeric. Initial range parameter in kilometers. Default: 10.
Represents distance at which correlation becomes negligible.</p></dd>


<dt id="arg-nugget">nugget<a class="anchor" aria-label="anchor" href="#arg-nugget"></a></dt>
<dd><p>Numeric. Initial nugget (y-intercept) for variogram. Default: 4.
Represents measurement error and micro-scale variation.</p></dd>


<dt id="arg-coord-cols">coord_cols<a class="anchor" aria-label="anchor" href="#arg-coord-cols"></a></dt>
<dd><p>Character vector of length 2. Column names for coordinates in
<code>bias_data</code>. Default: <code>c("lon", "lat")</code>. Use <code>c("x", "y")</code> if
data are already projected.</p></dd>


<dt id="arg-crs">crs<a class="anchor" aria-label="anchor" href="#arg-crs"></a></dt>
<dd><p>Character or numeric. Coordinate reference system for <code>bias_data</code>.
Default: "EPSG:4326" (WGS84). Must match <code>map_sd_raster</code> CRS or be
transformable to it.</p></dd>


<dt id="arg-remove-outliers">remove_outliers<a class="anchor" aria-label="anchor" href="#arg-remove-outliers"></a></dt>
<dd><p>Logical. Should extreme residuals (|resid| &gt; 3) be removed
before variogram fitting? Default: TRUE. Helps prevent fitting issues.</p></dd>


<dt id="arg-plot">plot<a class="anchor" aria-label="anchor" href="#arg-plot"></a></dt>
<dd><p>Logical. Should a diagnostic plot be generated? Default: TRUE. Shows
empirical variogram points and fitted model curve.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A list with class "residualVariogram" containing:</p><dl><dt>variogram_model</dt>
<dd><p>gstat vgm object with fitted variogram parameters</p></dd>

<dt>empirical_variogram</dt>
<dd><p>gstat variogram object with empirical semivariances</p></dd>

<dt>residuals</dt>
<dd><p>data.frame with columns: coordinates, bias, biasPred, sd,
resid0 (raw residuals), resid (scaled residuals)</p></dd>

<dt>resid_sf</dt>
<dd><p>sf object with residuals (used for variogram fitting)</p></dd>

<dt>fit_quality</dt>
<dd><p>data.frame with fitting diagnostics: SSErr (sum of squared
errors), RMSE, R2 (pseudo-R²)</p></dd>

<dt>n_obs</dt>
<dd><p>Integer. Number of observations used in fitting</p></dd>

<dt>n_removed</dt>
<dd><p>Integer. Number of outliers removed (if remove_outliers=TRUE)</p></dd>

<dt>plot</dt>
<dd><p>ggplot object if plot=TRUE, NULL otherwise</p></dd>


</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This function implements a residual variogram fitting approach with the following workflow:</p>
<ol><li><p>Extract SD values at plot locations from <code>map_sd_raster</code></p></li>
<li><p>Calculate raw residuals: resid0 = bias - biasPred</p></li>
<li><p>Scale residuals by map SD: resid = resid0 / sd</p></li>
<li><p>Optionally remove outliers (|resid| &gt; 3)</p></li>
<li><p>Convert to sf object for gstat</p></li>
<li><p>Fit empirical variogram with <code><a href="https://r-spatial.github.io/gstat/reference/variogram.html" class="external-link">gstat::variogram()</a></code></p></li>
<li><p>Fit theoretical variogram model with <code><a href="https://r-spatial.github.io/gstat/reference/fit.variogram.html" class="external-link">gstat::fit.variogram()</a></code></p></li>
</ol><p><strong>Scaled residuals:</strong> Scaling by SD is critical because it standardizes
residuals to unitless values, allowing variogram fitting across regions with
different absolute error magnitudes. The fitted variogram will be used to
create correlation matrices for uncertainty aggregation.</p>
<p><strong>Model selection:</strong> The default "Sph" (Spherical) model is appropriate for
most ecological data as it reaches a finite sill at a defined range. Use "Exp"
(Exponential) if correlation decays more gradually, or "Gau" (Gaussian) for very
smooth spatial processes.</p>
<p><strong>Initial parameters:</strong> The psill, range, and nugget parameters are starting
values for nonlinear optimization. Poor initial values can lead to convergence
issues. Inspect the empirical variogram first to choose reasonable starting values.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Araza, A., de Bruin, S., Herold, M., Quegan, S., Labrière, N., Rodriguez-Veiga, P.,
... &amp; Burt, A. (2022). A comprehensive framework for assessing the accuracy and
uncertainty of global above-ground biomass maps. Remote Sensing of Environment, 272, 112917.</p>
<p>Christensen, W. F. (2011). Filtered kriging for spatial data with heterogeneous
measurement error variances. Biometrics, 67(3), 947-957.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="trainBiasModel.html">trainBiasModel</a></code> for bias model training,
<code><a href="discountVariogram.html">discountVariogram</a></code> for variogram nugget adjustment,
<code><a href="aggregateUncertainty.html">aggregateUncertainty</a></code> for spatial uncertainty aggregation</p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Assuming you've run bias modeling workflow:</span></span></span>
<span class="r-in"><span><span class="co"># 1. Extract covariates and calculate bias</span></span></span>
<span class="r-in"><span><span class="va">bias_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="extractBiasCovariates.html">extractBiasCovariates</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  plot_data <span class="op">=</span> <span class="va">plots</span>,</span></span>
<span class="r-in"><span>  map_agb <span class="op">=</span> <span class="va">agb_map</span>,</span></span>
<span class="r-in"><span>  map_sd <span class="op">=</span> <span class="va">sd_map</span>,</span></span>
<span class="r-in"><span>  covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>height <span class="op">=</span> <span class="va">height_raster</span>, treecover <span class="op">=</span> <span class="va">tc_raster</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># 2. Train bias model</span></span></span>
<span class="r-in"><span><span class="va">bias_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="trainBiasModel.html">trainBiasModel</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  bias_data <span class="op">=</span> <span class="va">bias_data</span>,</span></span>
<span class="r-in"><span>  predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"map"</span>, <span class="st">"sd"</span>, <span class="st">"height"</span>, <span class="st">"treecover"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  cv_folds <span class="op">=</span> <span class="fl">10</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># 3. Add predictions to bias_data</span></span></span>
<span class="r-in"><span><span class="va">bias_data</span><span class="op">$</span><span class="va">biasPred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">bias_model</span><span class="op">$</span><span class="va">model</span>, data <span class="op">=</span> <span class="va">bias_data</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># 4. Fit residual variogram</span></span></span>
<span class="r-in"><span><span class="va">vgm_fit</span> <span class="op">&lt;-</span> <span class="fu">fitResidualVariogram</span><span class="op">(</span></span></span>
<span class="r-in"><span>  bias_data <span class="op">=</span> <span class="va">bias_data</span>,</span></span>
<span class="r-in"><span>  map_sd_raster <span class="op">=</span> <span class="va">sd_map</span>,</span></span>
<span class="r-in"><span>  model <span class="op">=</span> <span class="st">"Sph"</span>,</span></span>
<span class="r-in"><span>  cutoff <span class="op">=</span> <span class="fl">50</span>,</span></span>
<span class="r-in"><span>  psill <span class="op">=</span> <span class="fl">3</span>,</span></span>
<span class="r-in"><span>  range <span class="op">=</span> <span class="fl">10</span>,</span></span>
<span class="r-in"><span>  nugget <span class="op">=</span> <span class="fl">4</span>,</span></span>
<span class="r-in"><span>  coord_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  crs <span class="op">=</span> <span class="st">"EPSG:4326"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Inspect results</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">vgm_fit</span><span class="op">$</span><span class="va">variogram_model</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">vgm_fit</span><span class="op">$</span><span class="va">fit_quality</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">vgm_fit</span><span class="op">$</span><span class="va">plot</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Check residual distribution</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">vgm_fit</span><span class="op">$</span><span class="va">residuals</span><span class="op">$</span><span class="va">resid</span>, main <span class="op">=</span> <span class="st">"Scaled Residuals"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">vgm_fit</span><span class="op">$</span><span class="va">residuals</span><span class="op">$</span><span class="va">resid</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/arnanaraza" class="external-link">Arnan Araza</a>, <a href="https://github.com/aTnT" class="external-link">André Tavares</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

