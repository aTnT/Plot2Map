<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Discount Variogram Nugget for Plot Measurement Error — discountVariogram • Plot2Map</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.10/font.css" rel="stylesheet"><link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Discount Variogram Nugget for Plot Measurement Error — discountVariogram"><meta name="description" content="Adjusts the variogram nugget to account for plot-level measurement uncertainty
using the method of Christensen (2011). This is essential for proper uncertainty
quantification as it separates spatial variation (which aggregates differently)
from measurement error (which does not)."><meta property="og:description" content="Adjusts the variogram nugget to account for plot-level measurement uncertainty
using the method of Christensen (2011). This is essential for proper uncertainty
quantification as it separates spatial variation (which aggregates differently)
from measurement error (which does not)."><meta property="og:image" content="https://atnt.github.io/Plot2Map/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Plot2Map</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/introduction.html">Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/plot-data-preparation.html">Plot data preparation</a></li>
    <li><a class="dropdown-item" href="../articles/bias-modeling.html">Bias Modeling and Correction for AGB Maps</a></li>
    <li><a class="dropdown-item" href="../articles/als-lidar-validation.html">Validating AGB Maps with Airborne LiDAR Data</a></li>
    <li><a class="dropdown-item" href="../articles/advanced-uncertainty.html">Advanced Uncertainty Quantification with Spatial Correlation</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch"><li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Discount Variogram Nugget for Plot Measurement Error</h1>

      <div class="d-none name"><code>discountVariogram.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Adjusts the variogram nugget to account for plot-level measurement uncertainty
using the method of Christensen (2011). This is essential for proper uncertainty
quantification as it separates spatial variation (which aggregates differently)
from measurement error (which does not).</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">discountVariogram</span><span class="op">(</span></span>
<span>  <span class="va">variogram_fit</span>,</span>
<span>  <span class="va">plot_data</span>,</span>
<span>  filter_iqr <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  iqr_mult <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>  transfer_negative <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  plot <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-variogram-fit">variogram_fit<a class="anchor" aria-label="anchor" href="#arg-variogram-fit"></a></dt>
<dd><p>A residualVariogram object from <code><a href="fitResidualVariogram.html">fitResidualVariogram()</a></code>,
or a gstat vgm object to be discounted.</p></dd>


<dt id="arg-plot-data">plot_data<a class="anchor" aria-label="anchor" href="#arg-plot-data"></a></dt>
<dd><p>A data.frame with plot-level variance estimates. Must contain
columns: <code>varPlot</code> (plot measurement variance in (Mg/ha)²) and
<code>varMap</code> (map pixel variance in (Mg/ha)²). Typically obtained from
<code><a href="calculateTotalUncertainty.html">calculateTotalUncertainty()</a></code> or similar.</p></dd>


<dt id="arg-filter-iqr">filter_iqr<a class="anchor" aria-label="anchor" href="#arg-filter-iqr"></a></dt>
<dd><p>Logical. Should plots be filtered by IQR to remove extreme
variance ratios? Default: TRUE. Christensen (2011) recommends this to avoid
bias from outliers.</p></dd>


<dt id="arg-iqr-mult">iqr_mult<a class="anchor" aria-label="anchor" href="#arg-iqr-mult"></a></dt>
<dd><p>Numeric. IQR multiplier for outlier detection. Default: 1.5.
Plots with varPlot/varMap² outside the range
<code>[Q1 - iqr_mult * IQR, Q3 + iqr_mult * IQR]</code> are removed.</p></dd>


<dt id="arg-transfer-negative">transfer_negative<a class="anchor" aria-label="anchor" href="#arg-transfer-negative"></a></dt>
<dd><p>Logical. Should negative nugget values be transferred to
the partial sill? Default: TRUE. Prevents invalid variogram models when
discounting reduces nugget below zero.</p></dd>


<dt id="arg-plot">plot<a class="anchor" aria-label="anchor" href="#arg-plot"></a></dt>
<dd><p>Logical. Should a comparison plot be generated? Default: TRUE. Shows
original vs. discounted variogram models.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A list with class "discountedVariogram" containing:</p><dl><dt>discounted_variogram</dt>
<dd><p>gstat vgm object with adjusted nugget</p></dd>

<dt>original_variogram</dt>
<dd><p>gstat vgm object before discounting</p></dd>

<dt>discount_factor</dt>
<dd><p>Numeric. The discount value subtracted from nugget:
mean(varPlot / varMap²)</p></dd>

<dt>nugget_original</dt>
<dd><p>Numeric. Nugget before discounting</p></dd>

<dt>nugget_discounted</dt>
<dd><p>Numeric. Nugget after discounting (≥ 0)</p></dd>

<dt>nugget_transferred</dt>
<dd><p>Numeric. Amount transferred to partial sill if
nugget would have been negative</p></dd>

<dt>n_plots</dt>
<dd><p>Integer. Number of plots used in calculation</p></dd>

<dt>n_filtered</dt>
<dd><p>Integer. Number of plots removed by IQR filtering</p></dd>

<dt>plot</dt>
<dd><p>Function to generate comparison plot if plot=TRUE, NULL otherwise</p></dd>


</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This function implements the variogram discounting method from Christensen (2011)
as applied in Section 5 of the Mexico demo notebook (lines 1177-1213).</p>
<p><strong>Christensen (2011) method:</strong></p>
<p>The variogram nugget includes both true micro-scale spatial variation and plot
measurement error. To isolate spatial variation, we calculate:</p>
<p>$$discount = mean(varPlot / varMap^2)$$</p>
<p>And adjust the nugget:</p>
<p>$$nugget_{new} = nugget_{old} - discount$$</p>
<p><strong>IQR filtering:</strong> The variance ratio varPlot/varMap² can have extreme
values for plots with very low map variance or unusually high plot variance.
Christensen (2011) recommends filtering by the interquartile range (IQR) to
remove these outliers before calculating the mean discount factor.</p>
<p><strong>Negative nugget handling:</strong> If discounting results in a negative nugget,
the nugget is set to zero and the negative amount is added to the partial sill.
This ensures the variogram model remains valid while preserving total sill.</p>
<p><strong>Interpretation:</strong> A large discount factor indicates that plot measurement
error is a substantial component of the original nugget. After discounting, the
remaining nugget represents true micro-scale spatial variation plus any remaining
measurement error components.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Christensen, W. F. (2011). Filtered kriging for spatial data with heterogeneous
measurement error variances. Biometrics, 67(3), 947-957.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="fitResidualVariogram.html">fitResidualVariogram</a></code> for variogram fitting,
<code><a href="aggregateUncertainty.html">aggregateUncertainty</a></code> for using discounted variogram in aggregation</p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Assuming you have a fitted variogram and plot variance data:</span></span></span>
<span class="r-in"><span><span class="va">vgm_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="fitResidualVariogram.html">fitResidualVariogram</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  bias_data <span class="op">=</span> <span class="va">bias_data</span>,</span></span>
<span class="r-in"><span>  map_sd_raster <span class="op">=</span> <span class="va">sd_map</span>,</span></span>
<span class="r-in"><span>  coord_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  crs <span class="op">=</span> <span class="st">"EPSG:4326"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Calculate plot and map variances (example)</span></span></span>
<span class="r-in"><span><span class="va">variance_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  varPlot <span class="op">=</span> <span class="va">bias_data</span><span class="op">$</span><span class="va">sdPlot</span><span class="op">^</span><span class="fl">2</span>,  <span class="co"># From field measurement uncertainty</span></span></span>
<span class="r-in"><span>  varMap <span class="op">=</span> <span class="va">bias_data</span><span class="op">$</span><span class="va">sd</span><span class="op">^</span><span class="fl">2</span>         <span class="co"># From map pixel SD</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Discount the variogram</span></span></span>
<span class="r-in"><span><span class="va">vgm_discounted</span> <span class="op">&lt;-</span> <span class="fu">discountVariogram</span><span class="op">(</span></span></span>
<span class="r-in"><span>  variogram_fit <span class="op">=</span> <span class="va">vgm_fit</span>,</span></span>
<span class="r-in"><span>  plot_data <span class="op">=</span> <span class="va">variance_data</span>,</span></span>
<span class="r-in"><span>  filter_iqr <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>  iqr_mult <span class="op">=</span> <span class="fl">1.5</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Inspect results</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">vgm_discounted</span><span class="op">$</span><span class="va">discount_factor</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">vgm_discounted</span><span class="op">$</span><span class="va">discounted_variogram</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Show comparison plot</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">vgm_discounted</span><span class="op">$</span><span class="va">plot</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">vgm_discounted</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/arnanaraza" class="external-link">Arnan Araza</a>, <a href="https://github.com/aTnT" class="external-link">André Tavares</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

